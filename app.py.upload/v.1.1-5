from flask import Flask, request, jsonify
import gspread
import datetime
import uuid
from flask_cors import CORS 
import os
from dotenv import load_dotenv
import json
import requests 
import base64 

load_dotenv() 
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY") 

app = Flask(__name__)
CORS(app) 

SERVICE_ACCOUNT_FILE = 'service_account.json' 
# ğŸ‘‡ ë³¸ì¸ì˜ ì‹œíŠ¸ IDê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
SPREADSHEET_ID = '1tn2npx2hvbwVkpndUYW8y-V3qIVoV4sYgNcdCnkhKqA'

try:
    gc = gspread.service_account(filename=SERVICE_ACCOUNT_FILE)
    spreadsheet = gc.open_by_key(SPREADSHEET_ID)
    users_worksheet = spreadsheet.worksheet("users")
    ingredients_worksheet = spreadsheet.worksheet("ingredients")
    recipes_worksheet = spreadsheet.worksheet("recipes")
    print("âœ… Google Sheets ì—°ê²° ì„±ê³µ!")
except Exception as e:
    print(f"âŒ Google Sheets ì—°ê²° ì˜¤ë¥˜: {e}")

# --- ëª¨ë¸ ìë™ ì¡°íšŒ í•¨ìˆ˜ ---
def get_google_assigned_model(is_vision=False):
    try:
        url = f"https://generativelanguage.googleapis.com/v1beta/models?key={GEMINI_API_KEY}"
        response = requests.get(url)
        data = response.json()
        
        available_models = []
        if 'models' in data:
            for m in data['models']:
                if 'generateContent' in m.get('supportedGenerationMethods', []):
                    clean_name = m['name'].replace('models/', '')
                    available_models.append(clean_name)
        
        if not available_models: return "gemini-pro"

        selected_model = ""
        if is_vision:
            for m in available_models:
                if 'vision' in m or 'flash' in m:
                    selected_model = m
                    break
        else:
            for m in available_models:
                if 'flash' in m:
                    selected_model = m
                    break
            if not selected_model:
                for m in available_models:
                    if 'pro' in m:
                        selected_model = m
                        break
        
        return selected_model if selected_model else available_models[0]

    except: return "gemini-pro"

# --- API êµ¬í˜„ ---
@app.route('/', methods=['GET'])
def health_check(): return jsonify({"status": "Server is running"})

# ğŸ‘‡ğŸ‘‡ [ìˆ˜ì •ë¨] í”„ë¡œí•„ API (ì„¤ì •ê°’ 4ê°œ ì¶”ê°€ ì €ì¥/ë¡œë“œ) ğŸ‘‡ğŸ‘‡
@app.route('/users/<user_id>', methods=['GET', 'POST'])
def handle_user_profile(user_id):
    try:
        cell = users_worksheet.find(user_id)
        
        if request.method == 'GET':
            if cell:
                # A~Jì—´ê¹Œì§€ ê°€ì ¸ì˜¤ê¸° (ì´ 10ê°œ)
                row = users_worksheet.row_values(cell.row)
                row += [''] * (10 - len(row)) # ë¹ˆì¹¸ ì±„ìš°ê¸°
                return jsonify({
                    "allergies": row[1], "tools": row[2], 
                    "liked": row[3], "disliked": row[4], "goals": row[5],
                    # ì‹ ê·œ ì„¤ì •ê°’
                    "pref_scope": row[6], "pref_type": row[7],
                    "pref_occasion": row[8], "pref_difficulty": row[9]
                })
            else:
                return jsonify({"allergies": "", "tools": "", "liked": "", "disliked": "", "goals": "", "pref_scope":"", "pref_type":"", "pref_occasion":"", "pref_difficulty":""})

        elif request.method == 'POST':
            d = request.json
            # ì €ì¥ ë°ì´í„° ìˆœì„œ (A~J)
            new_row = [
                user_id,
                d.get('allergies', ''), d.get('tools', ''),
                d.get('liked', ''), d.get('disliked', ''), d.get('goals', ''),
                d.get('pref_scope', ''), d.get('pref_type', ''),
                d.get('pref_occasion', ''), d.get('pref_difficulty', '')
            ]
            
            if cell:
                users_worksheet.update(f"A{cell.row}:J{cell.row}", [new_row])
            else:
                users_worksheet.append_row(new_row)
            
            return jsonify({"message": "ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."}), 200

    except Exception as e: return jsonify({"error": str(e)}), 500

@app.route('/ingredients/<user_id>', methods=['GET', 'POST'])
def handle_ingredients(user_id):
    try:
        if request.method == 'GET':
            vals = ingredients_worksheet.get_all_values()
            headers = vals[0]
            data = []
            for r in vals[1:]:
                category = r[6] if len(r) > 6 else 'ê¸°íƒ€'
                if len(r) > 1 and r[1] == user_id: 
                    item = dict(zip(headers, r))
                    item['category'] = category
                    data.append(item)
            return jsonify(data)
        elif request.method == 'POST':
            if request.is_json:
                d = request.json
                ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, d['name'], d.get('quantity','1ê°œ'), '', 'text', d.get('category','ê¸°íƒ€')])
                return jsonify({"message": "ì¶”ê°€ ì™„ë£Œ"}), 201
            else: return jsonify({"error": "JSON ì•„ë‹˜"}), 400
    except Exception as e: return jsonify({"error": str(e)}), 500

@app.route('/ingredients/delete/<ingredient_id>', methods=['POST'])
def delete_ingredient(ingredient_id):
    return jsonify({"message": "ì‚­ì œ ì™„ë£Œ"}), 200

# ğŸ‘‡ğŸ‘‡ [ìˆ˜ì •ë¨] ë ˆì‹œí”¼ ìƒì„± (ì„¤ì •ê°’ ë°˜ì˜) ğŸ‘‡ğŸ‘‡
@app.route('/ai/generate', methods=['POST'])
def generate_recipe():
    try:
        data = request.json
        user_id = data.get('userId')
        
        vals = ingredients_worksheet.get_all_values()
        ing_list = [f"{r[2]}({r[3]})" for r in vals[1:] if r[1] == user_id]
        ing_str = ", ".join(ing_list)
        if not ing_str: return jsonify({"error": "ëƒ‰ì¥ê³ ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."}), 400

        # í”„ë¡œí•„ ë° ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸°
        user_info_txt = ""
        pref_txt = ""
        try:
            cell = users_worksheet.find(user_id)
            if cell:
                row = users_worksheet.row_values(cell.row)
                row += [''] * (10 - len(row))
                user_info_txt = f"ì•Œë ˆë¥´ê¸°:{row[1]}, ë„êµ¬:{row[2]}, ëª©í‘œ:{row[5]}"
                # ì„¤ì •ê°’ (ë²”ìœ„, ì¢…ë¥˜, ìƒí™©, ë‚œì´ë„)
                pref_txt = f"""
                [ìš”ë¦¬ ì„¤ì •]
                - ì¬ë£Œ ë²”ìœ„: {row[6]} (ì§‘ ì¬ë£Œë§Œ vs ì™¸ë¶€ ì¬ë£Œ í¬í•¨)
                - ìš”ë¦¬ ì¢…ë¥˜: {row[7]}
                - ì‹ì‚¬ ìƒí™©: {row[8]}
                - ë‚œì´ë„: {row[9]}
                """
        except: pass

        prompt_text = f"""
        [ëƒ‰ì¥ê³  ì¬ë£Œ] {ing_str}
        [ì‚¬ìš©ì ì •ë³´] {user_info_txt}
        {pref_txt}
        
        ìœ„ [ìš”ë¦¬ ì„¤ì •]ì„ ìµœìš°ì„ ìœ¼ë¡œ ë°˜ì˜í•´ì„œ ë ˆì‹œí”¼ 1ê°œë¥¼ ì¶”ì²œí•´ì¤˜.
        íŠ¹íˆ ì¬ë£Œ ë²”ìœ„ê°€ 'ì§‘ì— ìˆëŠ” ì¬ë£Œë§Œ'ì´ë¼ë©´ ëƒ‰ì¥ê³  ì¬ë£Œë§Œ ì¨ì•¼ í•´.
        
        ì‘ë‹µì€ JSON í˜•ì‹: {{ "recipeName": "ì´ë¦„", "materialsUsed": "ì¬ë£Œ", "cookingSteps": ["ë‹¨ê³„1", "ë‹¨ê³„2"], "tip": "íŒ" }}
        """
        
        model_name = get_google_assigned_model(is_vision=False)
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [{"text": prompt_text}] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if "error" in result: return jsonify({"error": result['error']['message']}), 500

        ai_text = result['candidates'][0]['content']['parts'][0]['text'].replace('```json', '').replace('```', '').strip()
        res_json = json.loads(ai_text)

        recipes_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('recipeName'), str(res_json.get('materialsUsed')), '', str(res_json)[:1000], str(datetime.datetime.now())])
        return jsonify(res_json)
    except Exception as e: return jsonify({"error": str(e)}), 500

@app.route('/ingredients/vision', methods=['POST'])
def vision_ingredient():
    try:
        if 'image' not in request.files: return jsonify({"error": "íŒŒì¼ ì—†ìŒ"}), 400
        file = request.files['image']
        user_id = request.form.get('userId')
        img_content = file.read()
        img_b64 = base64.b64encode(img_content).decode('utf-8')
        
        model_name = get_google_assigned_model(is_vision=True)
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [ {"text": "ì¬ë£Œ ì´ë¦„, ìˆ˜ëŸ‰, ì¹´í…Œê³ ë¦¬(ìœ¡ë¥˜/ì±„ì†Œ/ê³¼ì¼/ìœ ì œí’ˆ/ê°€ê³µ/ê¸°íƒ€)ë¥¼ JSONìœ¼ë¡œ: {\"name\": \"ì´ë¦„\", \"quantity\": \"ìˆ˜ëŸ‰\", \"category\":\"ì¹´í…Œê³ ë¦¬\"}"}, {"inline_data": {"mime_type": "image/jpeg", "data": img_b64}} ] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()
        if "error" in result: return jsonify({"error": result['error']['message']}), 500
            
        ai_text = result['candidates'][0]['content']['parts'][0]['text'].replace('```json', '').replace('```', '').strip()
        res_json = json.loads(ai_text)
        ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('name'), res_json.get('quantity'), '', 'vision', res_json.get('category','ê¸°íƒ€')])
        return jsonify(res_json)
    except Exception as e: return jsonify({"error": str(e)}), 500

@app.route('/ingredients/receipt', methods=['POST'])
def receipt_ocr():
    try:
        if 'image' not in request.files: return jsonify({"error": "íŒŒì¼ ì—†ìŒ"}), 400
        file = request.files['image']
        user_id = request.form.get('userId')
        img_content = file.read()
        img_b64 = base64.b64encode(img_content).decode('utf-8')
        
        model_name = get_google_assigned_model(is_vision=True)
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        headers = {'Content-Type': 'application/json'}
        prompt_text = """ì´ ì˜ìˆ˜ì¦ ì‚¬ì§„ì—ì„œ 'ì‹ì¬ë£Œ'ë§Œ ë½‘ì•„ì¤˜. ì‘ë‹µì€ JSON ë¦¬ìŠ¤íŠ¸ í˜•ì‹: [{"name": "ì´ë¦„", "quantity": "ìˆ˜ëŸ‰", "category": "ì¹´í…Œê³ ë¦¬"}] (ì¹´í…Œê³ ë¦¬: ìœ¡ë¥˜/ì±„ì†Œ/ê³¼ì¼/ìœ ì œí’ˆ/ê°€ê³µ/ê¸°íƒ€)"""
        
        payload = { "contents": [{ "parts": [ {"text": prompt_text}, {"inline_data": {"mime_type": "image/jpeg", "data": img_b64}} ] }] }
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()
        if "error" in result: return jsonify({"error": result['error']['message']}), 500
            
        ai_text = result['candidates'][0]['content']['parts'][0]['text'].replace('```json', '').replace('```', '').strip()
        items_list = json.loads(ai_text)
        if not isinstance(items_list, list): items_list = [items_list]

        count = 0
        for item in items_list:
            ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, item.get('name'), item.get('quantity','1ê°œ'), '', 'receipt', item.get('category','ê¸°íƒ€')])
            count += 1
        return jsonify({"message": f"{count}ê°œ ì™„ë£Œ", "items": items_list})
    except Exception as e: return jsonify({"error": str(e)}), 500

@app.route('/ai/chat', methods=['POST'])
def chat_chef():
    try:
        data = request.json
        user_msg = data.get('message')
        recipe_context = data.get('context', '')
        prompt_text = f"ìš”ë¦¬ ì±—ë´‡. ìƒí™©: {recipe_context}. ì§ˆë¬¸: {user_msg}. ì§§ê²Œ ë‹µë³€í•´ì¤˜."
        model_name = get_google_assigned_model(is_vision=False)
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [{"text": prompt_text}] }] }
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()
        if "error" in result: return jsonify({"error": "ë‹µë³€ ë¶ˆê°€"}), 500
        return jsonify({"answer": result['candidates'][0]['content']['parts'][0]['text']})
    except Exception as e: return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True, port=5000)
