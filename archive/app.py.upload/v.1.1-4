from flask import Flask, request, jsonify
import gspread
import datetime
import uuid
from flask_cors import CORS 
import os
from dotenv import load_dotenv
import json
import requests 
import base64 

# --- í™˜ê²½ ì„¤ì • ---
load_dotenv() 
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY") 

app = Flask(__name__)
CORS(app) 

# --- Google Sheets ì„¤ì • ---
SERVICE_ACCOUNT_FILE = 'service_account.json' 
SPREADSHEET_ID = '1tn2npx2hvbwVkpndUYW8y-V3qIVoV4sYgNcdCnkhKqA'

try:
    gc = gspread.service_account(filename=SERVICE_ACCOUNT_FILE)
    spreadsheet = gc.open_by_key(SPREADSHEET_ID)
    users_worksheet = spreadsheet.worksheet("users")
    ingredients_worksheet = spreadsheet.worksheet("ingredients")
    recipes_worksheet = spreadsheet.worksheet("recipes")
    print("âœ… Google Sheets ì—°ê²° ì„±ê³µ!")
except Exception as e:
    print(f"âŒ Google Sheets ì—°ê²° ì˜¤ë¥˜: {e}")

# --- ëª¨ë¸ ìë™ ì°¾ê¸° ---
def get_working_model_name():
    try:
        url = f"https://generativelanguage.googleapis.com/v1beta/models?key={GEMINI_API_KEY}"
        res = requests.get(url)
        data = res.json()
        if 'models' in data:
            for m in data['models']:
                if 'gemini-1.5-flash' in m['name']: return m['name'].replace('models/', '')
            for m in data['models']:
                if 'generateContent' in m.get('supportedGenerationMethods', []): return m['name'].replace('models/', '')
        return "gemini-pro"
    except: return "gemini-pro"

# --- API êµ¬í˜„ ---
@app.route('/', methods=['GET'])
def health_check():
    return jsonify({"status": "Server is running"})

@app.route('/users/<user_id>', methods=['GET', 'POST'])
def handle_user_profile(user_id):
    try:
        if request.method == 'GET':
            cell = users_worksheet.find(user_id)
            if cell:
                row = users_worksheet.row_values(cell.row) + [''] * 6
                return jsonify({"allergies": row[1], "tools": row[2], "liked": row[3], "disliked": row[4], "goals": row[5]})
            return jsonify({"allergies": "", "tools": "", "liked": "", "disliked": "", "goals": ""})
        elif request.method == 'POST':
            d = request.json
            row = [user_id, d.get('allergies',''), d.get('tools',''), d.get('liked',''), d.get('disliked',''), d.get('goals','')]
            cell = users_worksheet.find(user_id)
            if cell: users_worksheet.update(f"A{cell.row}:F{cell.row}", [row])
            else: users_worksheet.append_row(row)
            return jsonify({"message": "ì €ì¥ ì™„ë£Œ"}), 200
    except: return jsonify({"error": "error"}), 500

@app.route('/ingredients/<user_id>', methods=['GET', 'POST'])
def handle_ingredients(user_id):
    try:
        if request.method == 'GET':
            vals = ingredients_worksheet.get_all_values()
            headers = vals[0]
            data = []
            for r in vals[1:]:
                category = r[6] if len(r) > 6 else 'ê¸°íƒ€'
                if len(r) > 1 and r[1] == user_id: 
                    item = dict(zip(headers, r))
                    item['category'] = category
                    data.append(item)
            return jsonify(data)
        elif request.method == 'POST':
            if request.is_json:
                d = request.json
                ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, d['name'], d.get('quantity','1ê°œ'), '', 'text', d.get('category','ê¸°íƒ€')])
                return jsonify({"message": "ì¶”ê°€ ì™„ë£Œ"}), 201
            else: return jsonify({"error": "JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤"}), 400
    except Exception as e: return jsonify({"error": str(e)}), 500

@app.route('/ingredients/delete/<ingredient_id>', methods=['POST'])
def delete_ingredient(ingredient_id):
    return jsonify({"message": "ì‚­ì œ ì™„ë£Œ"}), 200

@app.route('/ai/generate', methods=['POST'])
def generate_recipe():
    try:
        data = request.json
        user_id = data.get('userId')
        vals = ingredients_worksheet.get_all_values()
        ing_list = [f"{r[2]}({r[3]})" for r in vals[1:] if r[1] == user_id]
        ing_str = ", ".join(ing_list)
        if not ing_str: return jsonify({"error": "ëƒ‰ì¥ê³ ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."}), 400

        # í”„ë¡œí•„ ì •ë³´ ì¶”ê°€
        user_info_txt = ""
        try:
            cell = users_worksheet.find(user_id)
            if cell:
                row = users_worksheet.row_values(cell.row) + [''] * 6
                user_info_txt = f"ì•Œë ˆë¥´ê¸°:{row[1]}, ë„êµ¬:{row[2]}, ì„ í˜¸:{row[3]}, ê¸°í”¼:{row[4]}, ëª©í‘œ:{row[5]}"
        except: pass

        prompt_text = f"""
        [ì¬ë£Œ] {ing_str}
        [í”„ë¡œí•„] {user_info_txt}
        ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì ì˜ ë ˆì‹œí”¼ 1ê°œë¥¼ ì¶”ì²œí•´ì¤˜.
        ì‘ë‹µì€ JSON í˜•ì‹: {{ "recipeName": "ì´ë¦„", "materialsUsed": "ì¬ë£Œ", "cookingSteps": ["ë‹¨ê³„1", "ë‹¨ê³„2"], "tip": "íŒ" }}
        """
        
        model_name = get_working_model_name()
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [{"text": prompt_text}] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if "error" in result: return jsonify({"error": result['error']['message']}), 500

        ai_text = result['candidates'][0]['content']['parts'][0]['text'].replace('```json', '').replace('```', '').strip()
        res_json = json.loads(ai_text)

        recipes_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('recipeName'), str(res_json.get('materialsUsed')), '', str(res_json)[:1000], str(datetime.datetime.now())])
        return jsonify(res_json)
    except Exception as e: return jsonify({"error": str(e)}), 500

# --- [ê¸°ëŠ¥ 2] ì¬ë£Œ ì‚¬ì§„ ì¸ì‹ (ê¸°ì¡´ ìœ ì§€) ---
@app.route('/ingredients/vision', methods=['POST'])
def vision_ingredient():
    try:
        if 'image' not in request.files: return jsonify({"error": "íŒŒì¼ ì—†ìŒ"}), 400
        file = request.files['image']
        user_id = request.form.get('userId')
        img_content = file.read()
        img_b64 = base64.b64encode(img_content).decode('utf-8')
        
        model_name = get_working_model_name()
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        headers = {'Content-Type': 'application/json'}
        
        # ë‹¨ì¼ ì¬ë£Œ ì¸ì‹ í”„ë¡¬í”„íŠ¸
        payload = { "contents": [{ "parts": [ {"text": "ì¬ë£Œ ì´ë¦„, ìˆ˜ëŸ‰, ì¹´í…Œê³ ë¦¬(ìœ¡ë¥˜/ì±„ì†Œ ë“±)ë¥¼ JSONìœ¼ë¡œ: {\"name\": \"ì´ë¦„\", \"quantity\": \"ìˆ˜ëŸ‰\", \"category\":\"ì¹´í…Œê³ ë¦¬\"}"}, {"inline_data": {"mime_type": "image/jpeg", "data": img_b64}} ] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()
        if "error" in result: return jsonify({"error": result['error']['message']}), 500
            
        ai_text = result['candidates'][0]['content']['parts'][0]['text'].replace('```json', '').replace('```', '').strip()
        res_json = json.loads(ai_text)

        ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('name'), res_json.get('quantity'), '', 'vision', res_json.get('category','ê¸°íƒ€')])
        return jsonify(res_json)
    except Exception as e: return jsonify({"error": str(e)}), 500

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ [ì‹ ê·œ ê¸°ëŠ¥] ì˜ìˆ˜ì¦ ìŠ¤ìº” (OCR) ğŸ‘‡ğŸ‘‡ğŸ‘‡
@app.route('/ingredients/receipt', methods=['POST'])
def receipt_ocr():
    try:
        if 'image' not in request.files: return jsonify({"error": "íŒŒì¼ ì—†ìŒ"}), 400
        file = request.files['image']
        user_id = request.form.get('userId')
        img_content = file.read()
        img_b64 = base64.b64encode(img_content).decode('utf-8')
        
        model_name = get_working_model_name()
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        headers = {'Content-Type': 'application/json'}
        
        # ì˜ìˆ˜ì¦ ì „ìš© ê°•ë ¥í•œ í”„ë¡¬í”„íŠ¸
        prompt_text = """
        ì´ ì‚¬ì§„ì€ ë§ˆíŠ¸ ì˜ìˆ˜ì¦ì´ì•¼. ì—¬ê¸°ì„œ 'ì‹ì¬ë£Œ' ëª©ë¡ë§Œ ì¶”ì¶œí•´ì¤˜.
        ê°€ê²©, ë‚ ì§œ, ê°€ê²Œì´ë¦„, ì„¸ê¸ˆ, ë´‰íˆ¬ê°’ ê°™ì€ ê±´ ë¬´ì‹œí•´.
        ì˜¤ì§ ë¨¹ì„ ìˆ˜ ìˆëŠ” ì¬ë£Œ ì´ë¦„ê³¼ ìˆ˜ëŸ‰ë§Œ í•„ìš”í•´.
        ì¹´í…Œê³ ë¦¬ëŠ” (ìœ¡ë¥˜/ì±„ì†Œ/ê³¼ì¼/ìœ ì œí’ˆ/ê°€ê³µ/ê¸°íƒ€) ì¤‘ í•˜ë‚˜ë¡œ ë¶„ë¥˜í•´ì¤˜.
        
        ì‘ë‹µì€ ë°˜ë“œì‹œ ì•„ë˜ì™€ ê°™ì€ JSON ë¦¬ìŠ¤íŠ¸ í˜•ì‹ì´ì–´ì•¼ í•´:
        [
            {"name": "ê³„ë€", "quantity": "1íŒ", "category": "ìœ ì œí’ˆ"},
            {"name": "ìš°ìœ ", "quantity": "2ê°œ", "category": "ìœ ì œí’ˆ"},
            {"name": "ì–‘íŒŒ", "quantity": "1ë§", "category": "ì±„ì†Œ"}
        ]
        """
        
        payload = { "contents": [{ "parts": [ {"text": prompt_text}, {"inline_data": {"mime_type": "image/jpeg", "data": img_b64}} ] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()
        
        if "error" in result: return jsonify({"error": result['error']['message']}), 500
            
        ai_text = result['candidates'][0]['content']['parts'][0]['text'].replace('```json', '').replace('```', '').strip()
        
        # ë¦¬ìŠ¤íŠ¸ í˜•íƒœì˜ JSON íŒŒì‹±
        items_list = json.loads(ai_text)
        
        # ê²°ê³¼ê°€ ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹ˆë©´ ë¦¬ìŠ¤íŠ¸ë¡œ ê°ì‹¸ê¸° (ë°©ì–´ ì½”ë“œ)
        if not isinstance(items_list, list):
            items_list = [items_list]

        # ì‹œíŠ¸ì— í•œêº¼ë²ˆì— ì¶”ê°€
        added_count = 0
        for item in items_list:
            ingredients_worksheet.append_row([
                str(uuid.uuid4()), 
                user_id, 
                item.get('name', 'ì•Œìˆ˜ì—†ìŒ'), 
                item.get('quantity', '1ê°œ'), 
                '', 
                'receipt', # ì˜ìˆ˜ì¦ìœ¼ë¡œ ë“±ë¡ë¨ í‘œì‹œ
                item.get('category', 'ê¸°íƒ€')
            ])
            added_count += 1
            
        return jsonify({"message": f"ì˜ìˆ˜ì¦ì—ì„œ {added_count}ê°œì˜ ì¬ë£Œë¥¼ ë°œê²¬í•˜ì—¬ ë“±ë¡í–ˆìŠµë‹ˆë‹¤!", "items": items_list})

    except Exception as e: return jsonify({"error": str(e)}), 500

# --- [ê¸°ëŠ¥ 3] ì±—ë´‡ ---
@app.route('/ai/chat', methods=['POST'])
def chat_chef():
    try:
        data = request.json
        user_msg = data.get('message')
        recipe_context = data.get('context', '')
        
        prompt_text = f"ìš”ë¦¬ ì±—ë´‡. ìƒí™©: {recipe_context}. ì§ˆë¬¸: {user_msg}. ì§§ê²Œ ë‹µë³€í•´ì¤˜."
        model_name = get_working_model_name()
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [{"text": prompt_text}] }] }
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if "error" in result: return jsonify({"error": "ë‹µë³€ ë¶ˆê°€"}), 500
        return jsonify({"answer": result['candidates'][0]['content']['parts'][0]['text']})
    except Exception as e: return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True, port=5000)
