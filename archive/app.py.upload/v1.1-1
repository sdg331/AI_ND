from flask import Flask, request, jsonify
import gspread
import datetime
import uuid
from flask_cors import CORS 
import os
from dotenv import load_dotenv
import json
import requests 
import base64 

# --- í™˜ê²½ ì„¤ì • ---
load_dotenv() 
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY") 

app = Flask(__name__)
CORS(app) 

# --- Google Sheets ì„¤ì • ---
SERVICE_ACCOUNT_FILE = 'service_account.json' 
SPREADSHEET_ID = '1tn2npx2hvbwVkpndUYW8y-V3qIVoV4sYgNcdCnkhKqA' # ì‚¬ìš©ì ID ê³ ì •

# --- [í•µì‹¬] 1. ì‹¤í–‰ ì‹œ ì‘ë™ ëª¨ë¸ì„ ì°¾ì•„ì„œ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ ---
def initialize_model_name():
    global WORKING_MODEL_NAME
    try:
        url = f"https://generativelanguage.googleapis.com/v1beta/models?key={GEMINI_API_KEY}"
        response = requests.get(url)
        data = response.json()
        
        # generateContentë¥¼ ì§€ì›í•˜ëŠ” ê°€ì¥ í‘œì¤€ì ì¸ ëª¨ë¸ì„ ì°¾ìŠµë‹ˆë‹¤.
        if 'models' in data:
            for m in data['models']:
                if 'generateContent' in m.get('supportedGenerationMethods', []):
                    # 1ìˆœìœ„: gemini-1.5-flash (ìµœê³  ì„±ëŠ¥)
                    if 'gemini-1.5-flash' in m['name']:
                        WORKING_MODEL_NAME = m['name'].replace('models/', '')
                        return WORKING_MODEL_NAME
                    # 2ìˆœìœ„: gemini-pro (ë ˆê±°ì‹œ ì•ˆì •ì„±)
                    elif 'gemini-pro' in m['name']:
                        WORKING_MODEL_NAME = m['name'].replace('models/', '')
                        return WORKING_MODEL_NAME
        
        WORKING_MODEL_NAME = "gemini-pro" # ìµœí›„ì˜ ìˆ˜ë‹¨
        return WORKING_MODEL_NAME
    except Exception as e:
        print(f"âš ï¸ ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì¤‘ í†µì‹  ì˜¤ë¥˜ ë°œìƒ. gemini-proë¡œ ê¸°ë³¸ ì„¤ì •ë¨: {e}")
        WORKING_MODEL_NAME = "gemini-pro"
        return WORKING_MODEL_NAME

# --- ì „ì—­ ë³€ìˆ˜ ì„¤ì • ---
WORKING_MODEL_NAME = initialize_model_name() 
print(f"âœ… AI ëª¨ë¸ í™•ì •: {WORKING_MODEL_NAME} ì‚¬ìš©")
# -----------------------------------------------

# Sheets ì—°ê²°ì€ ëª¨ë¸ ì„¤ì • ì´í›„ì— ì§„í–‰
try:
    gc = gspread.service_account(filename=SERVICE_ACCOUNT_FILE)
    spreadsheet = gc.open_by_key(SPREADSHEET_ID)
    users_worksheet = spreadsheet.worksheet("users")
    ingredients_worksheet = spreadsheet.worksheet("ingredients")
    recipes_worksheet = spreadsheet.worksheet("recipes")
    print("âœ… Google Sheets ì—°ê²° ì„±ê³µ!")
except Exception as e:
    print(f"âŒ Google Sheets ì—°ê²° ì˜¤ë¥˜: {e}")

# --- API êµ¬í˜„ ---
@app.route('/', methods=['GET'])
def health_check():
    return jsonify({"status": "Server is running"})

@app.route('/users/<user_id>', methods=['GET', 'POST'])
def handle_user_profile(user_id):
    try:
        if request.method == 'GET':
            return jsonify({"username": "User", "allergies": "", "tools": ""})
        else:
            return jsonify({"message": "ì €ì¥ ì™„ë£Œ"}), 200
    except: return jsonify({"error": "error"}), 500

@app.route('/ingredients/<user_id>', methods=['GET', 'POST'])
def handle_ingredients(user_id):
    try:
        if request.method == 'GET':
            vals = ingredients_worksheet.get_all_values()
            headers = vals[0]
            data = []
            for r in vals[1:]:
                category = r[6] if len(r) > 6 else 'ê¸°íƒ€'
                if len(r)>1 and r[1]==user_id: 
                    item = dict(zip(headers, r))
                    item['category'] = category
                    data.append(item)
            return jsonify(data)
        elif request.method == 'POST':
            if request.is_json:
                d = request.json
                ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, d['name'], d.get('quantity','1ê°œ'), '', 'text', d.get('category','ê¸°íƒ€')])
                return jsonify({"message": "ì¶”ê°€ ì™„ë£Œ"}), 201
            else:
                return jsonify({"error": "JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤"}), 400
    except Exception as e: return jsonify({"error": str(e)}), 500

@app.route('/ingredients/delete/<ingredient_id>', methods=['POST'])
def delete_ingredient(ingredient_id):
    return jsonify({"message": "ì‚­ì œ ì™„ë£Œ"}), 200

# --- [í•µì‹¬ 1] ë ˆì‹œí”¼ ìƒì„± (ë™ì  ëª¨ë¸ ì‚¬ìš©) ---
@app.route('/ai/generate', methods=['POST'])
def generate_recipe():
    try:
        data = request.json
        user_id = data.get('userId')
        
        vals = ingredients_worksheet.get_all_values()
        ing_list = [f"{r[2]}({r[3]})" for r in vals[1:] if r[1] == user_id]
        ing_str = ", ".join(ing_list)
        
        if not ing_str: return jsonify({"error": "ëƒ‰ì¥ê³ ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."}), 400

        prompt_text = f"""
        ì¬ë£Œ: {ing_str}
        ì´ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ìš”ë¦¬ ë ˆì‹œí”¼ 1ê°œë¥¼ ì¶”ì²œí•´ì¤˜.
        ì‘ë‹µì€ JSON í˜•ì‹ìœ¼ë¡œ:
        {{ "recipeName": "ì´ë¦„", "materialsUsed": "ì¬ë£Œ", "cookingSteps": ["ë‹¨ê³„1", "ë‹¨ê³„2"], "tip": "íŒ" }}
        """
        
        # ğŸ‘‡ í™•ì •ëœ ëª¨ë¸ ì´ë¦„ ì‚¬ìš©
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{WORKING_MODEL_NAME}:generateContent?key={GEMINI_API_KEY}"
        
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [{"text": prompt_text}] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if "error" in result:
             return jsonify({"error": f"AI ì˜¤ë¥˜: {result['error']['message']}"}), 500

        try:
            ai_text = result['candidates'][0]['content']['parts'][0]['text']
            ai_text = ai_text.replace('```json', '').replace('```', '').strip()
            res_json = json.loads(ai_text)
        except:
            res_json = {"recipeName": "AI ìš”ë¦¬", "materialsUsed": ing_str, "cookingSteps": [str(result)], "tip": "ì˜¤ë¥˜"}

        recipes_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('recipeName'), str(res_json.get('materialsUsed')), '', str(res_json)[:1000], str(datetime.datetime.now())])
        return jsonify(res_json)
    except Exception as e:
        return jsonify({"error": f"ì‹¤íŒ¨: {str(e)}"}), 500


# --- [í•µì‹¬ 2] ì‚¬ì§„ ì¸ì‹ (ë™ì  ëª¨ë¸ ì‚¬ìš©) ---
@app.route('/ingredients/vision', methods=['POST'])
def vision_ingredient():
    try:
        if 'image' not in request.files:
            return jsonify({"error": "ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."}), 400
        
        file = request.files['image']
        user_id = request.form.get('userId')
        
        img_content = file.read()
        img_b64 = base64.b64encode(img_content).decode('utf-8')
        
        # ğŸ‘‡ í™•ì •ëœ ëª¨ë¸ ì´ë¦„ ì‚¬ìš© (Textì™€ ë™ì¼)
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{WORKING_MODEL_NAME}:generateContent?key={GEMINI_API_KEY}"
        
        headers = {'Content-Type': 'application/json'}
        payload = {
            "contents": [{
                "parts": [
                    {"text": "ì´ ì‚¬ì§„ì— ìˆëŠ” ì‹ì¬ë£Œ ì´ë¦„ê³¼ ìˆ˜ëŸ‰ì„ JSONìœ¼ë¡œ ì•Œë ¤ì¤˜: {\"name\": \"ì´ë¦„\", \"quantity\": \"ìˆ˜ëŸ‰\", \"category\":\"ì¹´í…Œê³ ë¦¬\"}. ì¬ë£Œê°€ ì—¬ëŸ¬ê°œë©´ ê°€ì¥ ë©”ì¸ ì¬ë£Œ 1ê°œë§Œ."},
                    {"inline_data": {"mime_type": "image/jpeg", "data": img_b64}}
                ]
            }]
        }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()
        
        if "error" in result:
            return jsonify({"error": f"ì‚¬ì§„ ë¶„ì„ ì‹¤íŒ¨: {result['error']['message']}"}), 500
            
        ai_text = result['candidates'][0]['content']['parts'][0]['text']
        ai_text = ai_text.replace('```json', '').replace('```', '').strip()
        
        try:
            res_json = json.loads(ai_text)
        except:
            res_json = {"name": "ì‚¬ì§„ì¬ë£Œ", "quantity": "1ê°œ", "category": "ê¸°íƒ€"}

        ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('name','ì•Œìˆ˜ì—†ìŒ'), res_json.get('quantity','1ê°œ'), '', 'vision', res_json.get('category','ê¸°íƒ€')])
        return jsonify(res_json)

    except Exception as e:
        return jsonify({"error": f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}"}), 500

if __name__ == '__main__':
    app.run(debug=True, port=5000)
