from flask import Flask, request, jsonify
import gspread
import datetime
import uuid
from flask_cors import CORS 
import os
from dotenv import load_dotenv
import json
import requests 
import base64 

# --- í™˜ê²½ ì„¤ì • ---
load_dotenv() 
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY") 

app = Flask(__name__)
CORS(app) 

# --- Google Sheets ì„¤ì • ---
SERVICE_ACCOUNT_FILE = 'service_account.json' 
SPREADSHEET_ID = '1tn2npx2hvbwVkpndUYW8y-V3qIVoV4sYgNcdCnkhKqA'

try:
    gc = gspread.service_account(filename=SERVICE_ACCOUNT_FILE)
    spreadsheet = gc.open_by_key(SPREADSHEET_ID)
    users_worksheet = spreadsheet.worksheet("users")
    ingredients_worksheet = spreadsheet.worksheet("ingredients")
    recipes_worksheet = spreadsheet.worksheet("recipes")
    print("âœ… Google Sheets ì—°ê²° ì„±ê³µ!")
except Exception as e:
    print(f"âŒ Google Sheets ì—°ê²° ì˜¤ë¥˜: {e}")

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ [ìµœì¢… í•´ê²°ì±…] êµ¬ê¸€ì—ê²Œ ì§ì ‘ ë¬¼ì–´ë´ì„œ ì‘ë™í•˜ëŠ” ëª¨ë¸ ì°¾ê¸° ğŸ‘‡ğŸ‘‡ğŸ‘‡
def find_working_model():
    try:
        print("ğŸ” êµ¬ê¸€ ì„œë²„ì— ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ì„ ìš”ì²­ ì¤‘...")
        url = f"https://generativelanguage.googleapis.com/v1beta/models?key={GEMINI_API_KEY}"
        response = requests.get(url)
        data = response.json()
        
        if 'error' in data:
            print(f"âŒ API í‚¤ ì˜¤ë¥˜: {data['error']['message']}")
            return None

        # ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ í›„ë³´êµ° ì°¾ê¸°
        valid_models = []
        if 'models' in data:
            for m in data['models']:
                # ì±„íŒ…/ìƒì„±ì´ ê°€ëŠ¥í•œ ëª¨ë¸ë§Œ ê³¨ë¼ëƒ„
                if 'generateContent' in m.get('supportedGenerationMethods', []):
                    # ì´ë¦„ì—ì„œ 'models/' ì œê±° (ì˜ˆ: models/gemini-pro -> gemini-pro)
                    clean_name = m['name'].replace('models/', '')
                    valid_models.append(clean_name)
        
        if not valid_models:
            print("âŒ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª¨ë¸ì´ í•˜ë‚˜ë„ ì—†ìŠµë‹ˆë‹¤.")
            return None

        print(f"ğŸ“‹ ë°œê²¬ëœ ëª¨ë¸ ëª©ë¡: {valid_models}")

        # ìš°ì„ ìˆœìœ„: 1.5-flash -> 1.5-pro -> pro -> ì•„ë¬´ê±°ë‚˜
        preferred_order = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro', 'gemini-1.0-pro']
        
        # 1. ìš°ë¦¬ê°€ ì•„ëŠ” ì¢‹ì€ ëª¨ë¸ì´ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
        for pref in preferred_order:
            for valid in valid_models:
                if pref in valid: # ì˜ˆ: 'gemini-1.5-flash-001' ì•ˆì— 'gemini-1.5-flash'ê°€ í¬í•¨ë˜ë©´ ì„ íƒ
                    print(f"âœ… ìµœì  ëª¨ë¸ ì„ íƒë¨: {valid}")
                    return valid
        
        # 2. ì—†ìœ¼ë©´ ëª©ë¡ì˜ ì²« ë²ˆì§¸ ëª¨ë¸ ë¬´ì¡°ê±´ ì„ íƒ
        fallback = valid_models[0]
        print(f"âš ï¸ ìµœì  ëª¨ë¸ ì—†ìŒ. ì²« ë²ˆì§¸ ëª¨ë¸ ì‚¬ìš©: {fallback}")
        return fallback

    except Exception as e:
        print(f"âŒ ëª¨ë¸ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: {e}")
        return "gemini-pro" # ìµœí›„ì˜ ìˆ˜ë‹¨

# --- ì„œë²„ ì‹œì‘ ì‹œ ëª¨ë¸ í™•ì • ---
CURRENT_MODEL = find_working_model()
# ---------------------------

# --- API êµ¬í˜„ ---
@app.route('/', methods=['GET'])
def health_check():
    return jsonify({"status": "Server is running", "model": CURRENT_MODEL})

@app.route('/users/<user_id>', methods=['GET', 'POST'])
def handle_user_profile(user_id):
    try:
        if request.method == 'GET':
            return jsonify({"username": "User", "allergies": "", "tools": ""})
        else:
            return jsonify({"message": "ì €ì¥ ì™„ë£Œ"}), 200
    except: return jsonify({"error": "error"}), 500

@app.route('/ingredients/<user_id>', methods=['GET', 'POST'])
def handle_ingredients(user_id):
    try:
        if request.method == 'GET':
            vals = ingredients_worksheet.get_all_values()
            headers = vals[0]
            data = []
            for r in vals[1:]:
                category = r[6] if len(r) > 6 else 'ê¸°íƒ€'
                if len(r) > 1 and r[1] == user_id: 
                    item = dict(zip(headers, r))
                    item['category'] = category
                    data.append(item)
            return jsonify(data)
        elif request.method == 'POST':
            if request.is_json:
                d = request.json
                ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, d['name'], d.get('quantity','1ê°œ'), '', 'text', d.get('category','ê¸°íƒ€')])
                return jsonify({"message": "ì¶”ê°€ ì™„ë£Œ"}), 201
            else:
                return jsonify({"error": "JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤"}), 400
    except Exception as e: return jsonify({"error": str(e)}), 500

@app.route('/ingredients/delete/<ingredient_id>', methods=['POST'])
def delete_ingredient(ingredient_id):
    return jsonify({"message": "ì‚­ì œ ì™„ë£Œ"}), 200

# --- [ê¸°ëŠ¥ 1] ë ˆì‹œí”¼ ìƒì„± (ì°¾ì•„ë‚¸ ëª¨ë¸ ì‚¬ìš©) ---
@app.route('/ai/generate', methods=['POST'])
def generate_recipe():
    try:
        data = request.json
        user_id = data.get('userId')
        vals = ingredients_worksheet.get_all_values()
        ing_list = [f"{r[2]}({r[3]})" for r in vals[1:] if r[1] == user_id]
        ing_str = ", ".join(ing_list)
        
        if not ing_str: return jsonify({"error": "ëƒ‰ì¥ê³ ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."}), 400

        prompt_text = f"""
        ì¬ë£Œ: {ing_str}
        ì´ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ìš”ë¦¬ ë ˆì‹œí”¼ 1ê°œë¥¼ ì¶”ì²œí•´ì¤˜.
        ì‘ë‹µì€ JSON í˜•ì‹ìœ¼ë¡œ:
        {{ "recipeName": "ì´ë¦„", "materialsUsed": "ì¬ë£Œ", "cookingSteps": ["ë‹¨ê³„1", "ë‹¨ê³„2"], "tip": "íŒ" }}
        """
        
        # ğŸ‘‡ ìœ„ì—ì„œ ì°¾ì•„ë‚¸ 'ë˜ëŠ” ëª¨ë¸' ì£¼ì†Œ ì‚¬ìš©
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{CURRENT_MODEL}:generateContent?key={GEMINI_API_KEY}"
        
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [{"text": prompt_text}] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if "error" in result:
             return jsonify({"error": f"AI ì˜¤ë¥˜: {result['error']['message']}"}), 500

        try:
            ai_text = result['candidates'][0]['content']['parts'][0]['text']
            ai_text = ai_text.replace('```json', '').replace('```', '').strip()
            res_json = json.loads(ai_text)
        except:
            res_json = {"recipeName": "AI ìš”ë¦¬", "materialsUsed": ing_str, "cookingSteps": [str(result)], "tip": "ì˜¤ë¥˜"}

        recipes_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('recipeName'), str(res_json.get('materialsUsed')), '', str(res_json)[:1000], str(datetime.datetime.now())])
        return jsonify(res_json)
    except Exception as e:
        return jsonify({"error": f"ì‹¤íŒ¨: {str(e)}"}), 500


# --- [ê¸°ëŠ¥ 2] ì‚¬ì§„ ì¸ì‹ (ì°¾ì•„ë‚¸ ëª¨ë¸ ì‚¬ìš©) ---
@app.route('/ingredients/vision', methods=['POST'])
def vision_ingredient():
    try:
        if 'image' not in request.files:
            return jsonify({"error": "ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."}), 400
        
        file = request.files['image']
        user_id = request.form.get('userId')
        img_content = file.read()
        img_b64 = base64.b64encode(img_content).decode('utf-8')
        
        # ğŸ‘‡ ì‚¬ì§„ë„ ë˜‘ê°™ì€ ëª¨ë¸ ì‚¬ìš©
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{CURRENT_MODEL}:generateContent?key={GEMINI_API_KEY}"
        
        headers = {'Content-Type': 'application/json'}
        payload = {
            "contents": [{
                "parts": [
                    {"text": "ì´ ì‚¬ì§„ì— ìˆëŠ” ì‹ì¬ë£Œ ì´ë¦„ê³¼ ìˆ˜ëŸ‰ì„ JSONìœ¼ë¡œ ì•Œë ¤ì¤˜: {\"name\": \"ì´ë¦„\", \"quantity\": \"ìˆ˜ëŸ‰\", \"category\":\"ì¹´í…Œê³ ë¦¬\"}. ì¬ë£Œê°€ ì—¬ëŸ¬ê°œë©´ ê°€ì¥ ë©”ì¸ ì¬ë£Œ 1ê°œë§Œ."},
                    {"inline_data": {"mime_type": "image/jpeg", "data": img_b64}}
                ]
            }]
        }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()
        
        if "error" in result:
            return jsonify({"error": f"ì‚¬ì§„ ë¶„ì„ ì‹¤íŒ¨: {result['error']['message']}"}), 500
            
        ai_text = result['candidates'][0]['content']['parts'][0]['text']
        ai_text = ai_text.replace('```json', '').replace('```', '').strip()
        
        try:
            res_json = json.loads(ai_text)
        except:
            res_json = {"name": "ì‚¬ì§„ì¬ë£Œ", "quantity": "1ê°œ", "category": "ê¸°íƒ€"}

        ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('name','ì•Œìˆ˜ì—†ìŒ'), res_json.get('quantity','1ê°œ'), '', 'vision', res_json.get('category','ê¸°íƒ€')])
        return jsonify(res_json)

    except Exception as e:
        return jsonify({"error": f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}"}), 500

# --- [ê¸°ëŠ¥ 3] ì±—ë´‡ (ì°¾ì•„ë‚¸ ëª¨ë¸ ì‚¬ìš©) ---
@app.route('/ai/chat', methods=['POST'])
def chat_chef():
    try:
        data = request.json
        user_msg = data.get('message')
        recipe_context = data.get('context', '')
        
        prompt_text = f"ìš”ë¦¬ ì±—ë´‡. ìƒí™©: {recipe_context}. ì§ˆë¬¸: {user_msg}. ì§§ê²Œ ë‹µë³€í•´ì¤˜."
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{CURRENT_MODEL}:generateContent?key={GEMINI_API_KEY}"
        
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [{"text": prompt_text}] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if "error" in result:
             return jsonify({"error": "ë‹µë³€ ë¶ˆê°€"}), 500

        try:
            ai_answer = result['candidates'][0]['content']['parts'][0]['text']
            return jsonify({"answer": ai_answer})
        except:
            return jsonify({"answer": "ì£„ì†¡í•´ìš”, ë‹¤ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”."})

    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True, port=5000)
