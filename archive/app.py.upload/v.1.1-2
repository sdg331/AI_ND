from flask import Flask, request, jsonify
import gspread
import datetime
import uuid
from flask_cors import CORS 
import os
from dotenv import load_dotenv
import json
import requests 
import base64 

# --- í™˜ê²½ ì„¤ì • ---
load_dotenv() 
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY") 

app = Flask(__name__)
CORS(app) 

# --- Google Sheets ì„¤ì • ---
SERVICE_ACCOUNT_FILE = 'service_account.json' 
# ğŸ‘‡ğŸ‘‡ğŸ‘‡ ì‚¬ìš©ìë‹˜ ì‹œíŠ¸ ID (ê·¸ëŒ€ë¡œ ìœ ì§€) ğŸ‘‡ğŸ‘‡ğŸ‘‡
SPREADSHEET_ID = '1tn2npx2hvbwVkpndUYW8y-V3qIVoV4sYgNcdCnkhKqA'

try:
    gc = gspread.service_account(filename=SERVICE_ACCOUNT_FILE)
    spreadsheet = gc.open_by_key(SPREADSHEET_ID)
    users_worksheet = spreadsheet.worksheet("users")
    ingredients_worksheet = spreadsheet.worksheet("ingredients")
    recipes_worksheet = spreadsheet.worksheet("recipes")
    print("âœ… Google Sheets ì—°ê²° ì„±ê³µ!")
except Exception as e:
    print(f"âŒ Google Sheets ì—°ê²° ì˜¤ë¥˜: {e}")

# --- ëª¨ë¸ ìë™ ê°ì§€ í•¨ìˆ˜ (ì„±ê³µí–ˆë˜ ë¡œì§ ìœ ì§€) ---
def get_working_model_name():
    try:
        url = f"https://generativelanguage.googleapis.com/v1beta/models?key={GEMINI_API_KEY}"
        res = requests.get(url)
        data = res.json()
        if 'models' in data:
            for m in data['models']:
                if 'gemini-1.5-flash' in m['name']: return m['name'].replace('models/', '')
            for m in data['models']:
                if 'generateContent' in m.get('supportedGenerationMethods', []): return m['name'].replace('models/', '')
        return "gemini-pro"
    except: return "gemini-pro"

# --- API êµ¬í˜„ ---
@app.route('/', methods=['GET'])
def health_check():
    return jsonify({"status": "Server is running"})

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ [í•µì‹¬ ìˆ˜ì •] í”„ë¡œí•„ ê¸°ëŠ¥ ì—…ê·¸ë ˆì´ë“œ (6ê°œ í•­ëª© ì²˜ë¦¬) ğŸ‘‡ğŸ‘‡ğŸ‘‡
@app.route('/users/<user_id>', methods=['GET', 'POST'])
def handle_user_profile(user_id):
    try:
        # ì‹œíŠ¸ì—ì„œ ìœ ì € ìœ„ì¹˜ ì°¾ê¸°
        cell = users_worksheet.find(user_id)
        
        if request.method == 'GET':
            if cell:
                # ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê°€ì ¸ì˜´ (ë¹ˆì¹¸ ë°©ì§€ ì²˜ë¦¬ í¬í•¨)
                row = users_worksheet.row_values(cell.row)
                # ë°ì´í„°ê°€ ì§§ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¹ˆì¹¸ ì±„ìš°ê¸°
                row += [''] * (6 - len(row))
                
                return jsonify({
                    "allergies": row[1], # Bì—´
                    "tools": row[2],     # Cì—´
                    "liked": row[3],     # Dì—´ (ì‹ ê·œ)
                    "disliked": row[4],  # Eì—´ (ì‹ ê·œ)
                    "goals": row[5]      # Fì—´ (ì‹ ê·œ)
                })
            else:
                # ì—†ìœ¼ë©´ ë¹ˆ ê°’ ë°˜í™˜
                return jsonify({"allergies": "", "tools": "", "liked": "", "disliked": "", "goals": ""})

        elif request.method == 'POST':
            d = request.json
            # ì €ì¥í•  ë°ì´í„° ìˆœì„œ: ID, ì•Œë ˆë¥´ê¸°, ë„êµ¬, ì¢‹ì•„í•¨, ì‹«ì–´í•¨, ëª©í‘œ
            new_row = [
                user_id,
                d.get('allergies', ''),
                d.get('tools', ''),
                d.get('liked', ''),
                d.get('disliked', ''),
                d.get('goals', '')
            ]
            
            if cell:
                # ê¸°ì¡´ ìœ ì €ë©´ ë®ì–´ì“°ê¸° (A~Fì—´)
                users_worksheet.update(f"A{cell.row}:F{cell.row}", [new_row])
            else:
                # ìƒˆ ìœ ì €ë©´ ì¶”ê°€
                users_worksheet.append_row(new_row)
            
            return jsonify({"message": "í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."}), 200

    except Exception as e:
        return jsonify({"error": f"í”„ë¡œí•„ ì˜¤ë¥˜: {str(e)}"}), 500


@app.route('/ingredients/<user_id>', methods=['GET', 'POST'])
def handle_ingredients(user_id):
    try:
        if request.method == 'GET':
            vals = ingredients_worksheet.get_all_values()
            headers = vals[0]
            data = []
            for r in vals[1:]:
                category = r[6] if len(r) > 6 else 'ê¸°íƒ€'
                if len(r) > 1 and r[1] == user_id: 
                    item = dict(zip(headers, r))
                    item['category'] = category
                    data.append(item)
            return jsonify(data)
        elif request.method == 'POST':
            if request.is_json:
                d = request.json
                ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, d['name'], d.get('quantity','1ê°œ'), '', 'text', d.get('category','ê¸°íƒ€')])
                return jsonify({"message": "ì¶”ê°€ ì™„ë£Œ"}), 201
            else: return jsonify({"error": "JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤"}), 400
    except Exception as e: return jsonify({"error": str(e)}), 500

@app.route('/ingredients/delete/<ingredient_id>', methods=['POST'])
def delete_ingredient(ingredient_id):
    return jsonify({"message": "ì‚­ì œ ì™„ë£Œ"}), 200

@app.route('/ai/generate', methods=['POST'])
def generate_recipe():
    try:
        data = request.json
        user_id = data.get('userId')
        vals = ingredients_worksheet.get_all_values()
        ing_list = [f"{r[2]}({r[3]})" for r in vals[1:] if r[1] == user_id]
        ing_str = ", ".join(ing_list)
        if not ing_str: return jsonify({"error": "ëƒ‰ì¥ê³ ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."}), 400

        # í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (AIì—ê²Œ ì•Œë ¤ì£¼ê¸° ìœ„í•´)
        user_info_txt = "ì •ë³´ ì—†ìŒ"
        try:
            cell = users_worksheet.find(user_id)
            if cell:
                row = users_worksheet.row_values(cell.row)
                row += [''] * (6 - len(row))
                user_info_txt = f"ì•Œë ˆë¥´ê¸°({row[1]}), ë„êµ¬({row[2]}), ì„ í˜¸({row[3]}), ê¸°í”¼({row[4]}), ëª©í‘œ({row[5]})"
        except: pass

        model_name = get_working_model_name()
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        
        prompt_text = f"""
        [ìƒí™©] ëƒ‰ì¥ê³  ì¬ë£Œë¡œ ìš”ë¦¬ë¥¼ í•˜ë ¤ í•©ë‹ˆë‹¤.
        [ì¬ë£Œ] {ing_str}
        [ì‚¬ìš©ì í”„ë¡œí•„] {user_info_txt}
        
        ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì ì˜ ë ˆì‹œí”¼ 1ê°œë¥¼ ì¶”ì²œí•´ì¤˜.
        ì‘ë‹µì€ ë°˜ë“œì‹œ JSON í˜•ì‹: {{ "recipeName": "ì´ë¦„", "materialsUsed": "ì¬ë£Œ", "cookingSteps": ["ë‹¨ê³„1", "ë‹¨ê³„2"], "tip": "íŒ" }}
        """
        
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [{"text": prompt_text}] }] }
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if "error" in result: return jsonify({"error": f"AI ì˜¤ë¥˜: {result['error']['message']}"}), 500

        try:
            ai_text = result['candidates'][0]['content']['parts'][0]['text']
            ai_text = ai_text.replace('```json', '').replace('```', '').strip()
            res_json = json.loads(ai_text)
        except: res_json = {"recipeName": "ì˜¤ë¥˜", "materialsUsed": "", "cookingSteps": ["ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”"], "tip": ""}

        recipes_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('recipeName'), str(res_json.get('materialsUsed')), '', str(res_json)[:1000], str(datetime.datetime.now())])
        return jsonify(res_json)
    except Exception as e: return jsonify({"error": f"ì‹¤íŒ¨: {str(e)}"}), 500

@app.route('/ingredients/vision', methods=['POST'])
def vision_ingredient():
    try:
        if 'image' not in request.files: return jsonify({"error": "íŒŒì¼ ì—†ìŒ"}), 400
        file = request.files['image']
        user_id = request.form.get('userId')
        img_content = file.read()
        img_b64 = base64.b64encode(img_content).decode('utf-8')
        
        model_name = get_working_model_name()
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [ {"text": "ì¬ë£Œ ì´ë¦„, ìˆ˜ëŸ‰, ì¹´í…Œê³ ë¦¬(ìœ¡ë¥˜/ì±„ì†Œ ë“±)ë¥¼ JSONìœ¼ë¡œ: {\"name\": \"ì´ë¦„\", \"quantity\": \"ìˆ˜ëŸ‰\", \"category\":\"ì¹´í…Œê³ ë¦¬\"}"}, {"inline_data": {"mime_type": "image/jpeg", "data": img_b64}} ] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if "error" in result: return jsonify({"error": f"ë¶„ì„ ì‹¤íŒ¨: {result['error']['message']}"}), 500
            
        ai_text = result['candidates'][0]['content']['parts'][0]['text']
        ai_text = ai_text.replace('```json', '').replace('```', '').strip()
        try: res_json = json.loads(ai_text)
        except: res_json = {"name": "ì‚¬ì§„ì¬ë£Œ", "quantity": "1ê°œ", "category": "ê¸°íƒ€"}

        ingredients_worksheet.append_row([str(uuid.uuid4()), user_id, res_json.get('name'), res_json.get('quantity'), '', 'vision', res_json.get('category','ê¸°íƒ€')])
        return jsonify(res_json)
    except Exception as e: return jsonify({"error": f"ì˜¤ë¥˜: {str(e)}"}), 500
# --- [ì¶”ê°€ ê¸°ëŠ¥] ì‹¤ì‹œê°„ ìš”ë¦¬ í•´ê²°ì‚¬ ì±—ë´‡ ---
@app.route('/ai/chat', methods=['POST'])
def chat_chef():
    try:
        data = request.json
        user_msg = data.get('message')
        recipe_context = data.get('context', '') # í˜„ì¬ ë³´ê³  ìˆëŠ” ìš”ë¦¬ ì´ë¦„ (ì„ íƒì‚¬í•­)
        
        if not user_msg:
            return jsonify({"error": "ì§ˆë¬¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."}), 400

        # ì±—ë´‡ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ (ì§§ê³  ëª…í™•í•œ í•´ê²°ì±… ìš”êµ¬)
        prompt_text = f"""
        ë„ˆëŠ” ìš”ë¦¬ ì¤‘ ë°œìƒí•˜ëŠ” ë¬¸ì œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í•´ê²°í•´ì£¼ëŠ” 'ì¿ í‚¹ ë§ˆìŠ¤í„°'ì•¼.
        
        [í˜„ì¬ ìš”ë¦¬] {recipe_context}
        [ì‚¬ìš©ì ìƒí™©/ì§ˆë¬¸] {user_msg}
        
        ìœ„ ë¬¸ì œì— ëŒ€í•´ ë‹¹í™©í•˜ì§€ ë§ê³  ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ í•´ê²°ì±…ì„ 1~2ë¬¸ì¥ìœ¼ë¡œ ì§§ê³  ëª…í™•í•˜ê²Œ ì¡°ì–¸í•´ì¤˜.
        (ì¹œì ˆí•˜ê³  ë“ ë“ í•œ ë§íˆ¬ë¡œ)
        """
        
        # 1. ì‘ë™í•˜ëŠ” ëª¨ë¸ ì°¾ê¸°
        model_name = get_working_model_name()
        
        # 2. AI ìš”ì²­
        url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={GEMINI_API_KEY}"
        headers = {'Content-Type': 'application/json'}
        payload = { "contents": [{ "parts": [{"text": prompt_text}] }] }
        
        response = requests.post(url, headers=headers, json=payload)
        result = response.json()

        if "error" in result:
             return jsonify({"error": f"AI ì˜¤ë¥˜: {result['error']['message']}"}), 500

        # 3. ë‹µë³€ ì¶”ì¶œ
        try:
            ai_answer = result['candidates'][0]['content']['parts'][0]['text']
            return jsonify({"answer": ai_answer})
        except:
            return jsonify({"answer": "ì£„ì†¡í•´ìš”, ì§€ê¸ˆì€ ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ì—†ì–´ìš”. ë‹¤ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”."})

    except Exception as e:
        print(f"Chat Error: {e}")
        return jsonify({"error": f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}"}), 500
if __name__ == '__main__':
    app.run(debug=True, port=5000)
