<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COOKMATE</title>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #333; margin: 0; padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        input, button { padding: 12px; width: 100%; box-sizing: border-box; border-radius: 12px; border: 1px solid #ddd; font-size: 1rem; }
        input:focus { outline: none; border-color: #ff6b6b; }
        button { background-color: #ff6b6b; color: white; border: none; cursor: pointer; font-weight: bold; margin-top: 5px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: #868e96; }
        button.outline { background-color: white; color: #ff6b6b; border: 1px solid #ff6b6b; margin: 0; }

        /* íƒ­ë°” */
      /* íƒ­ë°” */
.bottom-nav { 
    position: fixed; 
    bottom: 0; 
    left: 50%; /* ì¤‘ì•™ ì •ë ¬ ê¸°ì¤€ì  */
    transform: translateX(-50%); /* ì¤‘ì•™ ì •ë ¬ */
    max-width: 600px; /* ë³¸ë¬¸ê³¼ ë™ì¼í•œ ë„ˆë¹„ ì œí•œ */
    width: 100%; 
    height: 70px; 
    background: white; 
    border-top: 1px solid #eee; 
    display: flex; 
    justify-content: space-around; 
    z-index: 1000; 
}
.nav-item { flex: 1; text-align: center; color: #adb5bd; font-size: 0.75rem; padding: 10px; background: none; border: none; cursor: pointer; }
.nav-item.active { color: #ff6b6b; font-weight: bold; }
        .nav-icon { display: block; font-size: 1.6rem; margin-bottom: 4px; }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ìŠ¤í¬ë¡¤ ë¸”ë¡ */
        .scroll-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; width: 100%; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
        .scroll-container::-webkit-scrollbar { height: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }
        .select-block { min-width: 90px; height: 80px; background: white; border: 2px solid #eee; border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .select-block.selected { border-color: #ff6b6b; background-color: #fff5f5; color: #ff6b6b; }
        .block-icon { font-size: 1.8rem; margin-bottom: 5px; }
        .block-text { font-size: 0.8rem; font-weight: bold; text-align: center;}

        /* ëª¨ë‹¬ (ì„¤ì • íŒì—…) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: popUp 0.3s; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: #333; }
        .close-btn { background: none; border: none; font-size: 1.5rem; color: #888; cursor: pointer; padding: 0; width: auto; box-shadow: none; }

        /* ì±—ë´‡ */
       /* ì±—ë´‡ */
/* ì±—ë´‡ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ ì¤‘ì•™ ì •ë ¬ëœ ëª¨ë°”ì¼ ë·°ì˜ ì¢Œì¸¡ í•˜ë‹¨ì— ê³ ì • */
/* ì±—ë´‡ í”Œë¡œíŒ… ë²„íŠ¼ (ì¢Œì¸¡ í•˜ë‹¨ìœ¼ë¡œ ì´ë™ ë° ì¤‘ì•™ ì •ë ¬ ê¸°ì¤€ ì„¤ì •) */
.chat-fab { 
    position: fixed; 
    bottom: 80px; 
    left: 50%; /* ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘ */
    transform: translateX(-300px); /* 600px ì»¨í…Œì´ë„ˆì˜ ì¢Œì¸¡ ê²½ê³„ì— ë§ì¶¤ */
    margin-left: 20px; /* ì¢Œì¸¡ì—ì„œ 20px ì—¬ë°± ì¶”ê°€ */
    width: 56px; height: 56px; 
    background-color: #228be6; 
    color: white; 
    border-radius: 50%; 
    display: flex; justify-content: center; align-items: center; 
    font-size: 24px; 
    box-shadow: 0 4px 15px rgba(34, 139, 230, 0.4); 
    z-index: 1500; cursor: pointer; 
    display: none; /* íƒ­ ì „í™˜ JSì—ì„œ ì œì–´í•  ìˆ˜ ìˆë„ë¡ ê¸°ë³¸ ìˆ¨ê¹€ */
}
/* ì±—ë´‡ ë§í’ì„  ìœ„ì¹˜ë„ FABì— ë§ì¶° ì¡°ì • */
.chat-bubble { 
    position: fixed; 
    bottom: 145px; 
    left: 50%; 
    transform: translateX(-295px); /* FAB ìœ„ì¹˜ì— ë§ì¶° ì¡°ì • */
    background: #fff; 
    padding: 8px 12px; 
    border-radius: 15px; 
    font-size: 0.8rem; 
    font-weight: bold; 
    color: #228be6; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    z-index: 2000; 
    pointer-events: none; 
    animation: float 2s infinite ease-in-out; 
}
/* ì±—ë´‡ ìœˆë„ìš° ì¤‘ì•™ ì •ë ¬ */
#chat-window { 
    display: none; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    width: 90%; /* ëª¨ë°”ì¼ ë·°ì— ë§ì¶° ê½‰ ì°¨ê²Œ */
    max-width: 400px; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
    height: 70vh; 
    background: white; 
    border-radius: 20px; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
    z-index: 3000; 
    flex-direction: column; 
    overflow: hidden; 
    border: 2px solid #e7f5ff; 
    resize: none; /* í¬ê¸° ì¡°ì ˆ ë°©ì§€ */
}.chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; font-size: 0.9rem; }
        .msg.user { align-self: flex-end; background: #228be6; color: white; }
        .msg.bot { align-self: flex-start; background: white; border: 1px solid #eee; }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; background: white; }
        
        /* ê¸°íƒ€ */
        #ingredient-list { list-style: none; padding: 0; }
        .ingredient-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .file-label { display: block; flex: 1; padding: 20px; background: #e7f5ff; color: #1c7ed6; text-align: center; border-radius: 15px; border: 2px dashed #74c0fc; cursor: pointer; }
        input[type="file"] { display: none; }
        #loading, #vision-loading { display: none; text-align: center; margin: 20px 0; color: #868e96; }
        .delete-btn { background: #ffc9c9; color: #c92a2a; padding: 8px 12px; width: auto; font-size: 0.8rem; border-radius: 8px; }
        #recipe-result { display: none; background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 20px; border: 1px solid #ffe3e3; }
        .pref-btn { background: #fff0f6; color: #e64980; border: 1px dashed #ff6b6b; width: 100%; padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: left; position: relative; }
        .pref-btn:after { content: 'âš™ï¸ ì„¤ì • >'; position: absolute; right: 15px; }
    /* --- [ì¶”ê°€ëœ ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼] --- */
        /* ìš°ì¸¡ í•˜ë‹¨ ê¸€ì“°ê¸° í”Œë¡œíŒ… ë²„íŠ¼ */
        /* ê¸€ì“°ê¸° ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨) */
        /* ê¸€ì“°ê¸° í”Œë¡œíŒ… ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨ìœ¼ë¡œ ì´ë™ ë° ì¤‘ì•™ ì •ë ¬ ê¸°ì¤€ ì„¤ì •) */
.fab-write { 
    position: fixed; 
    bottom: 80px; 
    left: 50%; /* ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘ */
    transform: translateX(250px); /* 600px ì»¨í…Œì´ë„ˆì˜ ìš°ì¸¡ ê²½ê³„(300px)ì—ì„œ 20px ì•ˆìª½ìœ¼ë¡œ (-300px + 280px) */
    margin-right: 20px; /* ìš°ì¸¡ì—ì„œ 20px ì—¬ë°± ì¶”ê°€ */
    width: 56px; height: 56px; 
    background-color: #ff6b6b; color: white; 
    border-radius: 50%; 
    display: flex; justify-content: center; align-items: center; 
    font-size: 24px; 
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); 
    z-index: 1500; cursor: pointer;
    display: none; /* ì±—ë´‡/ê¸€ì“°ê¸° ë²„íŠ¼ì´ ìƒì‹œ ë³´ì´ì§€ ì•Šë„ë¡ ê¸°ë³¸ ìˆ¨ê¹€ ì²˜ë¦¬ */
}
        
        /* ê¸€ì“°ê¸° ì…ë ¥ì°½ ë””ìì¸ */
        .write-textarea {
            width: 100%; height: 150px;
            padding: 15px; border: 1px solid #eee;
            border-radius: 12px; resize: none;
            font-family: inherit; font-size: 15px;
            box-sizing: border-box; margin-bottom: 10px;
        }
        .write-textarea:focus { outline: none; border-color: #ff6b6b; }
        /* --- [ì»¤ë®¤ë‹ˆí‹° ì„œë¸Œ íƒ­ ìŠ¤íƒ€ì¼] --- */
.comm-tabs { 
    display: flex; 
    border-bottom: 1px solid #eee; 
    margin-bottom: 15px; 
    background: white; 
    border-radius: 10px; 
    overflow: hidden; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
}
.comm-tab { 
    flex: 1; padding: 12px; text-align: center; cursor: pointer; 
    font-weight: 600; color: #888; border-bottom: 3px solid transparent; 
    transition: 0.2s; 
}
.comm-tab.active { 
    color: #ff6b6b; border-bottom: 3px solid #ff6b6b; 
    background-color: #fff5f5; 
}
.sub-content { display: none; }
.sub-content.active { display: block; }

/* ì¸ìŠ¤íƒ€ê·¸ë¨ í˜•íƒœì˜ í”¼ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.feed-card { 
    background: white; 
    border-radius: 15px; 
    overflow: hidden; 
    margin-bottom: 20px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
}
.feed-header { 
    padding: 12px 15px; 
    display: flex; 
    align-items: center; 
    border-bottom: 1px solid #f8f9fa; 
}
.profile-pic { 
    width: 36px; height: 36px; 
    background: #ffebeb; 
    border-radius: 50%; 
    margin-right: 10px; 
    display: flex; justify-content: center; align-items: center; 
    font-size: 18px; color: #ff6b6b; font-weight: bold; 
}
.feed-img { 
    width: 100%; 
    height: 250px; 
    object-fit: cover; 
    background: #f1f3f5; /* ë¡œë”© ë°°ê²½ */
}
.feed-body { padding: 15px; }
.feed-text { font-size: 15px; line-height: 1.5; color: #333; margin-bottom: 10px; }
.feed-meta { font-size: 12px; color: #888; display: flex; justify-content: space-between; align-items: center; }
.like-btn { 
    background: none; color: #ff6b6b; border: none; 
    padding: 5px 10px; width: auto; font-size: 16px; margin: 0; box-shadow: none; 
}
    </style>
</head>
<body>

<div style="background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.03);">
    <div style="display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto;">
        <h1 style="margin: 0; font-size: 1.3rem;">ğŸ¥• COOKMATE</h1>
        <div style="font-size: 0.8rem; color: #888;">
            <input type="text" id="my-user-id" value="user1" style="width: 60px; padding: 5px; text-align: center; display: inline-block;">
            <button onclick="loadData()" style="width: auto; padding: 5px 10px; font-size: 0.7rem;" class="outline">ğŸ”„</button>
        </div>
    </div>
</div>

<div class="container">
    <div id="tab-home" class="tab-content active">
        <h2 style="margin-top: 0;">ğŸ“¸ ì¬ë£Œ ì¶”ê°€</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <label for="my-img-input" class="file-label">ğŸ<br>ì‚¬ì§„ ì´¬ì˜</label>
            <label for="receipt-input" class="file-label" style="background:#f3f0ff; color:#7950f2; border-color:#b197fc;">ğŸ§¾<br>ì˜ìˆ˜ì¦ OCR</label>
        </div>
        <input type="file" id="my-img-input" accept="image/*" onchange="uploadImage()">
        <input type="file" id="receipt-input" accept="image/*" onchange="uploadReceipt()">
        <div id="vision-loading">ğŸ¤– ë¶„ì„ ì¤‘...</div>

        <div style="display: flex; gap: 8px; margin-top: 10px;">
            <input type="text" id="my-ing-name" placeholder="ì´ë¦„ (ì˜ˆ: ì–‘íŒŒ)" style="flex: 2;">
            <input type="text" id="my-ing-qty" placeholder="ìˆ˜ëŸ‰" style="flex: 1;">
            <button onclick="addIngredient()" style="flex: 1;">ì¶”ê°€</button>
        </div>
        <h2>ğŸ§Š ë‚˜ì˜ ëƒ‰ì¥ê³ </h2>
        <ul id="ingredient-list"></ul>
        <div id="empty-msg" style="text-align: center; color: #adb5bd; margin-top: 20px; display: none;">í…… ë¹„ì—ˆì–´ìš”!</div>
    </div>

    <div id="tab-recipe" class="tab-content">
        <div style="text-align: center; padding: 30px 0;">
            <button class="pref-btn" onclick="openPrefModal()">
                <strong>ğŸ§ ì–´ë–¤ ìš”ë¦¬ë¥¼ ë§Œë“¤ê¹Œìš”?</strong><br>
                <span style="font-size: 0.8rem; color: #868e96; font-weight: normal;">ì¬ë£Œë²”ìœ„, ì¢…ë¥˜, ìƒí™©, ë‚œì´ë„ ì„¤ì •</span>
            </button>

            <div style="font-size: 4rem;">ğŸ‘¨â€ğŸ³</div>
            <h3>AI ì…°í”„ì˜ ì¶”ì²œ</h3>
            <button onclick="generateRecipe()" style="width: auto; padding: 15px 30px; border-radius: 30px;">âœ¨ ë ˆì‹œí”¼ ì¶”ì²œë°›ê¸°</button>
        </div>
        <div id="loading">ìš”ë¦¬ ì¤‘...</div>
        <div id="recipe-result">
            <h3 id="res-title" style="color: #ff6b6b;"></h3>
            <p><strong>ğŸ›’ ì¬ë£Œ:</strong> <span id="res-materials"></span></p>
            <div id="res-steps" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="tab-profile" class="tab-content">
        <h2 style="margin-top: 0;">ğŸ‘¤ ê¸°ë³¸ í”„ë¡œí•„</h2>
        <label>ğŸš« ì•Œë ˆë¥´ê¸°</label><input type="text" id="prof-allergies">
        <label style="margin-top: 15px;">ğŸ”ª ì¡°ë¦¬ë„êµ¬</label><div class="scroll-container" id="tools-container"></div>
        <label style="margin-top: 15px;">ğŸ¯ ëª©í‘œ</label><div class="scroll-container" id="goals-container"></div>
        <button onclick="saveProfile()" style="margin-top: 30px;">ì €ì¥í•˜ê¸°</button>
    </div>
    <div id="tab-community" class="tab-content">
    
    <div class="comm-tabs" style="margin-top: 10px;">
        <div class="comm-tab active" data-tab="recommend" onclick="switchSubTab('recommend', this)">ì¶”ì²œ</div>
        <div class="comm-tab" data-tab="mine" onclick="switchSubTab('mine', this)">ë‚˜ì˜ ê¸€</div>
    </div>

    <div id="feed-recommend" class="sub-content active">
        <ul id="post-feed-list">
            </ul>
        <div id="empty-feed-recommend" style="text-align: center; color: #adb5bd; padding: 40px 0; display: none;">
            ì²« ë²ˆì§¸ í›„ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”! ğŸ“
        </div>
    </div>

    <div id="feed-mine" class="sub-content">
        <ul id="my-post-feed-list">
            </ul>
        <div id="empty-feed-mine" style="text-align: center; color: #adb5bd; padding: 40px 0; display: none;">
            ì•„ì§ ì‘ì„±í•œ ê¸€ì´ ì—†ì–´ìš”. âœï¸
        </div>
    </div>

</div>
</div>

<div id="pref-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ³ ë ˆì‹œí”¼ ì„¤ì •</h3>
            <button class="close-btn" onclick="closePrefModal()">âœ•</button>
        </div>
        
        <label>1. ì¬ë£Œ ë²”ìœ„</label>
        <div class="scroll-container" id="pref-scope-container"></div>
        
        <label style="margin-top: 20px;">2. ìš”ë¦¬ ì¢…ë¥˜</label>
        <div class="scroll-container" id="pref-type-container"></div>
        
        <label style="margin-top: 20px;">3. ìƒí™©</label>
        <div class="scroll-container" id="pref-occasion-container"></div>
        
        <label style="margin-top: 20px;">4. ë‚œì´ë„</label>
        <div class="scroll-container" id="pref-difficulty-container"></div>

        <button onclick="savePreferences()" style="margin-top: 30px;">ì„¤ì • ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<div class="chat-bubble">ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</div>
<div class="chat-fab" onclick="toggleChat()">ğŸ†˜</div>
<div id="chat-window" style="display:none;">
    <div class="chat-header"><span>ğŸ‘¨â€ğŸ³ ì¿ í‚¹ ì–´ì‹œìŠ¤í„´íŠ¸</span><button class="close-chat" onclick="toggleChat()">âœ•</button></div>
    <div class="chat-messages" id="chat-messages"><div class="msg bot">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div></div>
    <div class="chat-input-area"><input type="text" id="chat-input"><button onclick="sendChat()">ì „ì†¡</button></div>
</div>
<div class="fab-write" onclick="openWriteModal()">âœï¸</div>

<div id="write-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“ í›„ê¸° ì‘ì„±</h3>
            <button class="close-btn" onclick="closeWriteModal()">âœ•</button>
        </div>
        
        <textarea id="post-content" class="write-textarea" placeholder="ìš”ë¦¬ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ë ˆì‹œí”¼ í›„ê¸°ë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”!"></textarea>
        
        <label for="post-img-input" class="file-label" style="height: auto; padding: 15px; margin-bottom: 15px;">
            <span style="font-size: 1.2rem;">ğŸ“¸</span> ìš”ë¦¬ ì‚¬ì§„ ì˜¬ë¦¬ê¸°
        </label>
        <input type="file" id="post-img-input" accept="image/*">
        
        <button onclick="submitPost()">ë“±ë¡í•˜ê¸°</button>
    </div>
</div>
<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')"><span class="nav-icon">ğŸ§Š</span>ëƒ‰ì¥ê³ </button>
    <button class="nav-item" onclick="switchTab('recipe')"><span class="nav-icon">ğŸ§‘â€ğŸ³</span>AI ì…°í”„</button>
    <button class="nav-item" onclick="switchTab('community')"><span class="nav-icon">ğŸ’¬</span>ì»¤ë®¤ë‹ˆí‹°</button>
    <button class="nav-item" onclick="switchTab('profile')"><span class="nav-icon">ğŸ‘¤</span>í”„ë¡œí•„</button>
</nav>

<script>
    const API_URL = "http://127.0.0.1:5000";
    let currentRecipeName = "";

    // --- ë°ì´í„° ì •ì˜ ---
    const PREF_SCOPE = [{icon:"ğŸ ",name:"ì§‘ ì¬ë£Œë§Œ"}, {icon:"ğŸ›’",name:"ì™¸ë¶€ ì¬ë£Œ í¬í•¨"}];
    const PREF_TYPE = [{icon:"ğŸš",name:"ì‹ì‚¬"}, {icon:"ğŸ¥ª",name:"ê°„ì‹"}, {icon:"ğŸº",name:"ì•ˆì£¼"}];
    const PREF_OCCASION = [{icon:"ğŸ™",name:"í˜¼ì"}, {icon:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§",name:"ê°€ì¡±"}, {icon:"ğŸ‰",name:"ì†ë‹˜ì ‘ëŒ€"}];
    const PREF_DIFFICULTY = [{icon:"ğŸ£",name:"ì‰¬ì›€"}, {icon:"ğŸ‘¨â€ğŸ³",name:"ë³´í†µ"}, {icon:"ğŸ”¥",name:"ì–´ë ¤ì›€"}];
    const TOOL_LIST = [{icon:"ğŸ³",name:"í”„ë¼ì´íŒ¬"},{icon:"ğŸ”¥",name:"ê°€ìŠ¤ë ˆì¸ì§€"},{icon:"ğŸ¥˜",name:"ëƒ„ë¹„"},{icon:"â™¨ï¸",name:"ì—ì–´í”„ë¼ì´ì–´"},{icon:"ğŸ•",name:"ì˜¤ë¸"},{icon:"âš¡",name:"ì „ìë ˆì¸ì§€"}];
    const GOAL_LIST = [{icon:"ğŸ¥—",name:"ë‹¤ì´ì–´íŠ¸"},{icon:"ğŸ’ª",name:"ê³ ë‹¨ë°±"},{icon:"ğŸ§‚",name:"ì €ì—¼ì‹"},{icon:"ğŸŒ¿",name:"ë¹„ê±´"}];

    // --- UI í•¨ìˆ˜ ---
    function createBlocks(cid, list, sel, multi=true) {
        const c = document.getElementById(cid); c.innerHTML = ''; 
        const sels = sel ? sel.split(',').map(s=>s.trim()) : [];
        list.forEach(i => {
            const d = document.createElement('div'); d.className = 'select-block';
            if(sels.includes(i.name)) d.classList.add('selected');
            d.onclick = () => {
                if(!multi) { // ë‹¨ì¼ ì„ íƒ ëª¨ë“œ
                    Array.from(c.children).forEach(child=>child.classList.remove('selected'));
                    d.classList.add('selected');
                } else { // ë‹¤ì¤‘ ì„ íƒ ëª¨ë“œ
                    d.classList.toggle('selected');
                }
            };
            d.innerHTML = `<span class="block-icon">${i.icon}</span><span class="block-text">${i.name}</span>`;
            c.appendChild(d);
        });
    }
    function getVal(cid) { return Array.from(document.querySelectorAll(`#${cid} .select-block.selected .block-text`)).map(el=>el.innerText).join(','); }

    // --- ëª¨ë‹¬ ì œì–´ ---
    function openPrefModal() { document.getElementById('pref-modal').style.display = 'flex'; }
    function closePrefModal() { document.getElementById('pref-modal').style.display = 'none'; }

    // --- ë°ì´í„° ë¡œë“œ & ì €ì¥ ---
    async function loadData() {
        const uid = document.getElementById('my-user-id').value;
        // ì¬ë£Œ ë¡œë“œ
        try {
            const r = await fetch(`${API_URL}/ingredients/${uid}`); const l = await r.json();
            const ul = document.getElementById('ingredient-list'); ul.innerHTML = '';
            if(l.length===0) document.getElementById('empty-msg').style.display='block';
            else { document.getElementById('empty-msg').style.display='none'; l.forEach(i=>{ul.innerHTML+=`<li class="ingredient-item"><span>${i.name} ${i.quantity}</span><button class="delete-btn" onclick="del('${i.id}')">ì‚­ì œ</button></li>`}); }
        } catch(e){}
        // í”„ë¡œí•„ & ì„¤ì • ë¡œë“œ
        try {
            const r = await fetch(`${API_URL}/users/${uid}`); const d = await r.json();
            if(!d.error) {
                // ê¸°ë³¸ í”„ë¡œí•„
                document.getElementById('prof-allergies').value = d.allergies||'';
                createBlocks('tools-container', TOOL_LIST, d.tools||'');
                createBlocks('goals-container', GOAL_LIST, d.goals||'');
                // ë ˆì‹œí”¼ ì„¤ì • (ë‹¨ì¼ ì„ íƒ)
                createBlocks('pref-scope-container', PREF_SCOPE, d.pref_scope||'', false);
                createBlocks('pref-type-container', PREF_TYPE, d.pref_type||'', false);
                createBlocks('pref-occasion-container', PREF_OCCASION, d.pref_occasion||'', false);
                createBlocks('pref-difficulty-container', PREF_DIFFICULTY, d.pref_difficulty||'', false);
            }
        } catch(e){}
    }

    async function saveProfile() {
        const uid = document.getElementById('my-user-id').value;
        const d = { allergies: document.getElementById('prof-allergies').value, tools: getVal('tools-container'), goals: getVal('goals-container') };
        await sendUpdate(uid, d);
    }

    async function savePreferences() {
        const uid = document.getElementById('my-user-id').value;
        const d = {
            pref_scope: getVal('pref-scope-container'),
            pref_type: getVal('pref-type-container'),
            pref_occasion: getVal('pref-occasion-container'),
            pref_difficulty: getVal('pref-difficulty-container')
        };
        await sendUpdate(uid, d);
        closePrefModal();
    }

    async function sendUpdate(uid, data) {
        try { await fetch(`${API_URL}/users/${uid}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)}); alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"); }
        catch(e) { alert("ì˜¤ë¥˜"); }
    }

    // --- ê¸°íƒ€ ê¸°ëŠ¥ (ì±—ë´‡, íƒ­ì „í™˜, ë ˆì‹œí”¼ìƒì„± ë“±) ---
    // (ê¸°ì¡´ switchTab í•¨ìˆ˜ ì „ì²´ë¥¼ ì´ ì½”ë“œë¡œ ë®ì–´ì“°ì„¸ìš”)
function switchTab(n) {
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.getElementById('tab-'+n).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
    
    // ë²„íŠ¼ í™œì„±í™”
    if(n=='home') document.querySelectorAll('.nav-item')[0].classList.add('active');
    if(n=='recipe') document.querySelectorAll('.nav-item')[1].classList.add('active');
    if(n=='community') {
        document.querySelectorAll('.nav-item')[2].classList.add('active');
        // ğŸ‘‡ ì»¤ë®¤ë‹ˆí‹° íƒ­ ì§„ì… ì‹œ: ê¸°ë³¸ê°’ ('recommend')ìœ¼ë¡œ í”¼ë“œ ë¡œë“œ
        switchSubTab('recommend', document.querySelector('.comm-tab[data-tab="recommend"]'));
    }
    if(n=='profile') document.querySelectorAll('.nav-item')[3].classList.add('active');

    // ê¸€ì“°ê¸°/ì±—ë´‡ ë²„íŠ¼ ê°€ì‹œì„± ì œì–´ (ì´ì „ ë‹¨ê³„ì—ì„œ ìˆ˜ì •í•œ ë¡œì§)
    const fabWrite = document.querySelector('.fab-write');
    const fabChat = document.querySelector('.chat-fab');
    if (fabWrite) { fabWrite.style.display = (n === 'community') ? 'flex' : 'none'; }
    if (fabChat) { fabChat.style.display = (n === 'recipe') ? 'flex' : 'none'; }

    // ì±—ë´‡ ë§í’ì„  ì œì–´
    const chatBubble = document.querySelector('.chat-bubble');
    if (chatBubble) {
        chatBubble.style.display = (n === 'recipe') ? 'block' : 'none'; 
    }
}
    async function addIngredient() {
        const uid = document.getElementById('my-user-id').value; const n = document.getElementById('my-ing-name').value; const q = document.getElementById('my-ing-qty').value;
        if(!n) return alert("ì…ë ¥í•˜ì„¸ìš”");
        await fetch(`${API_URL}/ingredients/${uid}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:n, quantity:q})});
        loadData();
    }
    async function del(id) { if(confirm("ì‚­ì œ?")) { await fetch(`${API_URL}/ingredients/delete/${id}`, {method:'POST'}); loadData(); } }
    async function uploadImage() { /* ê¸°ì¡´ ì‚¬ì§„ ì½”ë“œ */ }
    async function uploadReceipt() { /* ê¸°ì¡´ ì˜ìˆ˜ì¦ ì½”ë“œ */ }
    
    function toggleChat() { const w = document.getElementById('chat-window'); w.style.display = (w.style.display==='flex')?'none':'flex'; }
    async function sendChat() {
        const i = document.getElementById('chat-input'); const m = i.value; if(!m) return;
        const c = document.getElementById('chat-messages'); c.innerHTML+=`<div class="msg user">${m}</div>`; i.value='';
        try { const r = await fetch(`${API_URL}/ai/chat`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:m, context:currentRecipeName})}); const d = await r.json(); c.innerHTML+=`<div class="msg bot">${d.answer||d.error}</div>`; }
        catch(e){ c.innerHTML+=`<div class="msg bot">ì˜¤ë¥˜</div>`; }
    }

    // (ê¸°ì¡´ function generateRecipe() í•¨ìˆ˜ ì „ì²´ë¥¼ ì´ ì½”ë“œë¡œ ë®ì–´ì“°ì„¸ìš”)
// (ê¸°ì¡´ function generateRecipe() í•¨ìˆ˜ ì „ì²´ë¥¼ ì´ ì½”ë“œë¡œ ë®ì–´ì“°ì„¸ìš”)
async function generateRecipe() {
    const userId = document.getElementById('my-user-id').value;
    document.getElementById('loading').style.display = 'block'; 
    document.getElementById('recipe-result').style.display = 'none';
    
    try {
        const response = await fetch(`${API_URL}/ai/generate`, {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userId })
        });
        const result = await response.json();
        
        document.getElementById('loading').style.display = 'none';

        if (result.error) {
            alert(result.error);
        } else {
            // [í•µì‹¬ ìˆ˜ì •]: Array.isArray() ì²´í¬ í›„ ë°°ì—´ ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
            const materials = Array.isArray(result.materialsUsed) 
                              ? result.materialsUsed.join(', ') // ë°°ì—´ì´ë©´ ì‰¼í‘œë¡œ ì—°ê²°
                              : result.materialsUsed; // ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©

            const stepsHtml = Array.isArray(result.cookingSteps)
                              ? result.cookingSteps.map(s => `<p>ğŸ³ ${s}</p>`).join('') // ë°°ì—´ì´ë©´ <p> íƒœê·¸ë¡œ ê°ì‹¸ì„œ ì—°ê²°
                              : `<p>ğŸ³ ${result.cookingSteps}</p>`; // ë°°ì—´ì´ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©

            // ë ˆì‹œí”¼ ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (FinishCooking í•¨ìˆ˜ì—ì„œ ì‚¬ìš©)
            window.currentRecipeName = result.recipeName;
            window.currentRecipeIngredientsText = materials; 
            
            // 1. ê²°ê³¼ í™”ë©´ í‘œì‹œ
            document.getElementById('res-title').innerText = result.recipeName;
            document.getElementById('res-materials').innerHTML = materials; 
            document.getElementById('res-steps').innerHTML = stepsHtml; // ì¡°ë¦¬ ìˆœì„œ HTML ì‚½ì…
            
            // 2. íŒê³¼ ë²„íŠ¼ ì˜ì—­ ì—…ë°ì´íŠ¸
            document.getElementById('res-tip').innerHTML = result.tip;

            // 3. ìš”ë¦¬ ì‹œì‘ ë²„íŠ¼ ì˜ì—­ í‘œì‹œ (ìƒˆë¡œ ìƒì„±ëœ ë²„íŠ¼ ë¡œì§ í¬í•¨)
            const buttonContainer = document.getElementById('cooking-action-area');
            if (buttonContainer) { // ë§Œì•½ ì´ì „ì— ë²„íŠ¼ì´ ìˆì—ˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ë‘ê³ , ì—†ë‹¤ë©´ ì¶”ê°€
                 buttonContainer.innerHTML = `
                    <button id="start-cooking-btn" onclick="startCooking()" style="background: #20c997; flex: 1;">ìš”ë¦¬ ì‹œì‘</button>
                    <button id="finish-cooking-btn" class="hidden" onclick="finishCooking()" style="background: #fa5252; flex: 1;">ìš”ë¦¬ ì™„ë£Œ (ì¬ë£Œ ì°¨ê°)</button>
                 `;
            }

            document.getElementById('recipe-result').style.display = 'block';
        }
    } catch (e) {
        alert("ì˜¤ë¥˜ ë°œìƒ");
        document.getElementById('loading').style.display = 'none';
    }
}
// --- [ì¶”ê°€] ê¸€ì“°ê¸° ëª¨ë‹¬ ì œì–´ ê¸°ëŠ¥ ---
    function openWriteModal() {
        // [ì¤‘ìš”] ëª¨ë‹¬ì´ ëœ° ë•Œ, í˜„ì¬ ë¡œê·¸ì¸ëœ ìœ ì € IDë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        if (document.getElementById('my-user-id').value === "") {
            alert("ì‚¬ìš©ì IDë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        // ëª¨ë‹¬ íŒì—… ë„ìš°ê¸°
        document.getElementById('write-modal').style.display = 'flex';
        // ì±—ë´‡ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        document.getElementById('chat-window').style.display = 'none';
    }

    function closeWriteModal() {
        document.getElementById('write-modal').style.display = 'none';
        // í¼ ì´ˆê¸°í™” (ì‚¬ì§„ ì…ë ¥ì°½ ì´ˆê¸°í™”)
        document.getElementById('post-img-input').value = ''; 
    }
    // --- [ì‹ ê·œ ê¸°ëŠ¥: ì»¤ë®¤ë‹ˆí‹° JS ë¡œì§] ---
// --- [ì‹ ê·œ ê¸°ëŠ¥: ê²Œì‹œê¸€ ì‘ì„± (POST) ë¡œì§] ---
// (ê¸°ì¡´ submitPost í•¨ìˆ˜ ì „ì²´ë¥¼ ì´ ì½”ë“œë¡œ ë®ì–´ì“°ì„¸ìš”)
async function submitPost() {
    const userId = document.getElementById('my-user-id').value;
    const content = document.getElementById('post-content').value;
    // index.htmlì— ìˆëŠ” input fileì˜ IDë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤. 
    // ê¸°ì¡´ ì½”ë“œì—ì„œëŠ” post-img-inputì´ì—ˆìŠµë‹ˆë‹¤.
    const imgFile = document.getElementById('post-img-input').files[0]; 

    if (!content.trim() && !imgFile) {
        alert("ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ì‚¬ì§„ì„ ì²¨ë¶€í•´ ì£¼ì„¸ìš”.");
        return;
    }
    if (!userId) {
        alert("ì‚¬ìš©ì IDë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    const formData = new FormData();
    formData.append('userId', userId);
    formData.append('content', content);
    
    if (imgFile) {
        // ë°±ì—”ë“œ app.pyì—ì„œ 'image'ë¡œ ë°›ìœ¼ë¯€ë¡œ ì´ë¦„ í†µì¼
        formData.append('image', imgFile); 
    }
    
    const submitButton = document.querySelector('#write-modal button[onclick="submitPost()"]');
    submitButton.textContent = 'ë“±ë¡ ì¤‘...';
    submitButton.disabled = true;

    try {
        // ğŸš¨ ìˆ˜ì •: URLì„ '/community/posts' (ë³µìˆ˜)ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
        const response = await fetch(`${API_URL}/community/posts`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert("í›„ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            document.getElementById('post-content').value = '';
            closeWriteModal();
            
            const isMine = (currentCommunityFilter === 'mine');
            // ë“±ë¡ í›„, í˜„ì¬ íƒ­ ê¸°ì¤€ìœ¼ë¡œ í”¼ë“œ ìƒˆë¡œê³ ì¹¨
            loadCommunityPosts(isMine);

        } else {
            const errorText = await response.text();
            alert(`í›„ê¸° ë“±ë¡ ì‹¤íŒ¨: ${errorText}`);
        }
    } catch (e) {
        console.error("ê²Œì‹œê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
        alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        submitButton.textContent = 'ë“±ë¡í•˜ê¸°';
        submitButton.disabled = false;
    }
}
// --- [ì‹ ê·œ ê¸°ëŠ¥: ê²Œì‹œê¸€ 'ì¢‹ì•„ìš”' ê¸°ëŠ¥] ---
// ì´ í•¨ìˆ˜ëŠ” app.pyì˜ POST /community/posts/like ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
async function toggleLike(postId) {
    try {
        const response = await fetch(`${API_URL}/community/posts/like`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ postId: postId })
        });

        if (response.ok) {
            // ì¢‹ì•„ìš” ì„±ê³µ í›„, í˜„ì¬ í™œì„±í™”ëœ íƒ­ ê¸°ì¤€ìœ¼ë¡œ í”¼ë“œ ìƒˆë¡œê³ ì¹¨
            const isMine = (currentCommunityFilter === 'mine');
            loadCommunityPosts(isMine);
        } else {
            const errorText = await response.text();
            alert(`ì¢‹ì•„ìš” ì‹¤íŒ¨: ${errorText}`);
        }
    } catch (e) {
        console.error("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
        alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}
// ê²Œì‹œê¸€ ëª©ë¡ì„ í™”ë©´ì— ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì™„ì„±ë¨)
// (ê¸°ì¡´ renderPosts í•¨ìˆ˜ ì „ì²´ë¥¼ ì´ ì½”ë“œë¡œ ë®ì–´ì“°ì„¸ìš”)
function renderPosts(posts, isMine) {
    const targetListId = isMine ? 'my-post-feed-list' : 'post-feed-list';
    const ul = document.getElementById(targetListId);
    
    // ì´ì „ì— ìˆ¨ê²¨ë‘” 'ë¹ˆ í”¼ë“œ' ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ìˆ¨ê¹€ ì²˜ë¦¬
    document.getElementById('empty-feed-recommend').style.display = 'none';
    document.getElementById('empty-feed-mine').style.display = 'none';
    
    ul.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°

    if (posts.length === 0) {
        // ëª©ë¡ì´ ë¹„ì–´ìˆë‹¤ë©´ í•´ë‹¹ íƒ­ì— ë§ëŠ” ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
        const emptyMsgId = isMine ? 'empty-feed-mine' : 'empty-feed-recommend';
        document.getElementById(emptyMsgId).style.display = 'block';
        return;
    }

    // ê²Œì‹œê¸€ ì¹´ë“œë¥¼ í™”ë©´ì— ê·¸ë¦¬ëŠ” í•µì‹¬ ë¡œì§
    posts.forEach(post => {
        // ì´ë¯¸ì§€ëŠ” Base64 ë°ì´í„°ì´ë¯€ë¡œ ì§ì ‘ ì†ŒìŠ¤ë¡œ ì‚¬ìš© ê°€ëŠ¥
        const imageHtml = post.image ? 
            `<div class="feed-img" style="background-image: url('data:image/jpeg;base64,${post.image}'); background-size: cover; background-position: center;"></div>` : 
            `<div class="feed-img" style="height: 100px; padding: 20px;">ì‚¬ì§„ ì—†ìŒ</div>`;

        // ê²Œì‹œê¸€ HTML ì¹´ë“œ ìƒì„±
        const cardHtml = `
            <li class="feed-card">
                <div class="feed-header">
                    <div class="profile-pic">ğŸ‘¤</div>
                    <div>
                        <strong style="font-size: 14px;">${post.nickname || post.userId}</strong>
                        <div style="font-size: 11px; color: #888;">${new Date(post.timestamp).toLocaleDateString()}</div>
                    </div>
                </div>

                ${imageHtml}
                
                <div class="feed-body">
                    <p class="feed-text">${post.content}</p>
                    <div class="feed-meta">
                        <span style="font-weight: 600;">ì¢‹ì•„ìš” ${post.likes || 0}ê°œ</span>
                        <button class="like-btn" onclick="toggleLike('${post.id}')">â¤ï¸</button>
                    </div>
                </div>
            </li>
        `;
        ul.innerHTML += cardHtml; // ëª©ë¡ì— ì¶”ê°€
    });
}
let currentCommunityFilter = 'recommend'; // í˜„ì¬ í™œì„± ì„œë¸Œ íƒ­ ìƒíƒœ ì €ì¥

// ë°±ì—”ë“œì—ì„œ ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
async function loadCommunityPosts(isMine) {
    const userId = document.getElementById('my-user-id').value;
    const filterId = isMine ? userId : ''; // 'ë‚˜ì˜ ê¸€' íƒ­ì¼ ê²½ìš°ë§Œ userIdë¡œ í•„í„°ë§

    // ë¡œë”© ì²˜ë¦¬ (í•„ìš”í•˜ë‹¤ë©´ ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ ì—¬ê¸°ì— ë„ìš¸ ìˆ˜ ìˆìŒ)

    try {
        // ë°±ì—”ë“œ API í˜¸ì¶œ (GET /community/posts)
        const response = await fetch(`${API_URL}/community/posts?userId=${filterId}`);
        const posts = await response.json();
        
        renderPosts(posts, isMine); 
    } catch (e) {
        console.error("ê²Œì‹œê¸€ ë¡œë”© ì‹¤íŒ¨:", e);
        // alert("ê²Œì‹œê¸€ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); // ì˜¤ë¥˜ê°€ ë„ˆë¬´ ìì£¼ ëœ¨ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
    }
}

// ì„œë¸Œ íƒ­ ì „í™˜ ë¡œì§ (ì¶”ì²œ / ë‚˜ì˜ ê¸€)
function switchSubTab(tabName, el) {
    // 1. UI ìŠ¤íƒ€ì¼ ì „í™˜
    document.querySelectorAll('.comm-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    
    // 2. ë‚´ìš© ì˜ì—­ ì „í™˜
    document.querySelectorAll('.sub-content').forEach(c => c.classList.remove('active'));
    document.getElementById('feed-' + tabName).classList.add('active');
    
    currentCommunityFilter = tabName; // í•„í„° ìƒíƒœ ì €ì¥
    
    // 3. ë°ì´í„° ë¡œë“œ íŠ¸ë¦¬ê±°
    const isMine = (tabName === 'mine');
    loadCommunityPosts(isMine);
}
// --- [ì‹ ê·œ ê¸°ëŠ¥: ìš”ë¦¬ ì‹œì‘/ì™„ë£Œ ë° ì¬ë£Œ ì°¨ê° ë¡œì§] ---

// CSS ì¶”ê°€: hidden í´ë˜ìŠ¤ë¥¼ í™œìš©í•˜ê¸° ìœ„í•œ ìŠ¤íƒ€ì¼ì„ <style> íƒœê·¸ ë‚´ë¶€ì— ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
/* <style> íƒœê·¸ ì•ˆì— ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.
.hidden {
    display: none !important;
}
*/

// ìš”ë¦¬ ì‹œì‘: ë²„íŠ¼ì„ ì „í™˜í•˜ê³  ì¤€ë¹„ ìƒíƒœë¥¼ í‘œì‹œ
function startCooking() {
    document.getElementById('start-cooking-btn').classList.add('hidden');
    document.getElementById('finish-cooking-btn').classList.remove('hidden');
    alert(`[${window.currentRecipeName}] ìš”ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤! ì¬ë£Œ ì°¨ê° ì¤€ë¹„ ì™„ë£Œ.`);
}

// ìš”ë¦¬ ì™„ë£Œ: ì¬ë£Œë¥¼ ì°¨ê°í•˜ê³  ëƒ‰ì¥ê³  DBì— ë°˜ì˜
async function finishCooking() {
    const userId = document.getElementById('my-user-id').value;
    
    // ğŸš¨ ì—¬ê¸°ì„œ ë°±ì—”ë“œë¡œ ì „ì†¡í•  ë°ì´í„°ëŠ” ì¬ë£Œ íŒŒì‹±ì´ ì™„ë£Œëœ ìƒíƒœì—¬ì•¼ í•©ë‹ˆë‹¤.
    const deductionData = {
        userId: userId,
        // ì´ í…ìŠ¤íŠ¸ë¥¼ ë°±ì—”ë“œê°€ ë°›ì•„ì„œ ì¬ë£Œì™€ ìˆ˜ëŸ‰ì„ íŒŒì‹±í•´ì•¼ í•©ë‹ˆë‹¤.
        recipeMaterialsText: window.currentRecipeIngredientsText, 
        recipeName: window.currentRecipeName 
    };
    
    if (!confirm(`[${window.currentRecipeName}] ìš”ë¦¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ë ˆì‹œí”¼ì— ì“°ì¸ ì¬ë£Œë¥¼ ëƒ‰ì¥ê³ ì—ì„œ ì°¨ê°í• ê¹Œìš”?`)) {
        document.getElementById('start-cooking-btn').classList.remove('hidden');
        document.getElementById('finish-cooking-btn').classList.add('hidden');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/refrigerator/deduct`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(deductionData)
        });

        if (response.ok) {
            alert("ìš”ë¦¬ ì™„ë£Œ! ì¬ë£Œê°€ ì„±ê³µì ìœ¼ë¡œ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ˜Š");
            loadData(); // ëƒ‰ì¥ê³  ëª©ë¡ ê°±ì‹ 
        } else {
            const errorText = await response.text();
            alert(`ì¬ë£Œ ì°¨ê° ì‹¤íŒ¨: ${errorText}. ë°±ì—”ë“œì—ì„œ íŒŒì‹± ë¡œì§ì„ í™•ì¸í•˜ì„¸ìš”.`);
        }
    } catch (e) {
        console.error("ì¬ë£Œ ì°¨ê° ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", e);
        alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        // ë²„íŠ¼ ì›ìƒ ë³µêµ¬
        document.getElementById('start-cooking-btn').classList.remove('hidden');
        document.getElementById('finish-cooking-btn').classList.add('hidden');
    }
}
    window.onload = function() { loadData(); switchTab('home'); };
</script>
</body>
</html>
