<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ³ cookmate</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FFB84D;
            --secondary: #FFA940;
            --bg: #FFFBF0;
            --card: #FFFFFF;
            --text: #5C4A3A;
            --text-light: #9C8A7A;
            --border: #FFE7BA;
            --hover: #FFF4E0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        .app-header { background-color: var(--primary); padding: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(255,184,77,0.2); }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto; }
        .app-title { margin: 0; font-size: 1.5rem; font-weight: 700; color: white; }
        .user-section { display: flex; align-items: center; gap: 8px; }
        #my-user-id { width: 70px; padding: 8px 12px; text-align: center; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        #my-user-id::placeholder { color: rgba(255,255,255,0.7); }

        input, button { padding: 12px; width: 100%; box-sizing: border-box; border-radius: 12px; border: 1px solid var(--border); font-size: 1rem; font-family: inherit; transition: all 0.3s; }
        input:focus { outline: none; border-color: var(--primary); }
        button { background-color: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: var(--secondary); }
        button.outline { background-color: white; color: var(--primary); border: 1px solid var(--primary); margin: 0; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .hidden { display: none !important; }

        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); max-width: 600px; width: 100%; height: 70px; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: var(--text-light); font-size: 0.75rem; padding: 10px; background: none; border: none; cursor: pointer; box-shadow: none; width: auto; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { display: block; font-size: 1.6rem; margin-bottom: 4px; }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .scroll-container { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; width: 100%; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
        .scroll-container::-webkit-scrollbar { height: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        .select-block { min-width: 90px; height: 80px; background: white; border: 2px solid var(--border); border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .select-block.selected { border-color: var(--primary); background-color: var(--hover); color: var(--primary); }
        .block-icon { font-size: 1.8rem; margin-bottom: 5px; }
        .block-text { font-size: 0.8rem; font-weight: bold; text-align: center; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: popUp 0.3s; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: var(--text); }
        .close-btn { background: none; border: none; font-size: 1.5rem; color: #888; cursor: pointer; padding: 0; width: auto; box-shadow: none; }

        .chat-fab { position: fixed; bottom: 90px; left: 20px; width: 56px; height: 56px; background-color: var(--secondary); color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 15px rgba(255,169,64,0.4); z-index: 1500; cursor: pointer; }
        .chat-bubble { position: fixed; bottom: 155px; left: 25px; background: #fff; padding: 8px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 2000; pointer-events: none; animation: float 2s infinite ease-in-out; display: none; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        #chat-window { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; height: 70vh; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 3000; flex-direction: column; overflow: hidden; border: 2px solid var(--border); }
        .chat-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .close-chat { background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.2rem; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; padding: 0; box-shadow: none; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: var(--bg); display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; font-size: 0.9rem; }
        .msg.user { align-self: flex-end; background: var(--primary); color: white; }
        .msg.bot { align-self: flex-start; background: white; border: 1px solid var(--border); }
        .chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 5px; background: white; }
        #chat-input { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 20px; }

        #ingredient-list { list-style: none; padding: 0; }
        .ingredient-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .file-label { display: block; flex: 1; padding: 20px; background: var(--hover); color: var(--primary); text-align: center; border-radius: 15px; border: 2px dashed var(--primary); cursor: pointer; font-weight: 600; }
        input[type="file"] { display: none; }
        #loading, #vision-loading { display: none; text-align: center; margin: 20px 0; color: var(--primary); }
        .delete-btn { background: #ffc9c9; color: #c92a2a; padding: 8px 12px; width: auto; font-size: 0.8rem; border-radius: 8px; }
        #recipe-result { display: none; background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 20px; border: 1px solid var(--border); }
        .pref-btn { background: var(--hover); color: var(--primary); border: 1px dashed var(--primary); width: 100%; padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: left; position: relative; }
        .pref-btn:after { content: 'âš™ï¸ ì„¤ì • >'; position: absolute; right: 15px; }

        .fab-write { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; background-color: var(--primary); color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 15px rgba(255,184,77,0.4); z-index: 1500; cursor: pointer; }
        .write-textarea { width: 100%; height: 150px; padding: 15px; border: 1px solid var(--border); border-radius: 12px; resize: none; font-family: inherit; font-size: 15px; box-sizing: border-box; margin-bottom: 10px; }
        .write-textarea:focus { outline: none; border-color: var(--primary); }

        .comm-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .comm-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 600; color: #888; border-bottom: 3px solid transparent; transition: 0.2s; background: none; box-shadow: none; width: auto; }
        .comm-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); background-color: var(--hover); }
        .sub-content { display: none; }
        .sub-content.active { display: block; }

        .feed-card { background: white; border-radius: 15px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .feed-header { padding: 12px 15px; display: flex; align-items: center; border-bottom: 1px solid var(--bg); }
        .profile-pic { width: 36px; height: 36px; background: var(--hover); border-radius: 50%; margin-right: 10px; display: flex; justify-content: center; align-items: center; font-size: 18px; color: var(--primary); font-weight: bold; }
        .feed-img { width: 100%; height: 200px; background: linear-gradient(135deg, var(--hover), var(--border)); display: flex; align-items: center; justify-content: center; color: var(--text-light); }
        .feed-body { padding: 15px; }
        .feed-text { font-size: 15px; line-height: 1.5; color: var(--text); margin-bottom: 10px; }
        .feed-meta { font-size: 12px; color: #888; display: flex; justify-content: space-between; align-items: center; }
        .like-btn { background: var(--hover); color: var(--primary); border: none; padding: 8px 15px; width: auto; font-size: 14px; margin: 0; box-shadow: none; border-radius: 20px; }

        h2 { color: var(--primary); font-size: 1.3rem; margin: 20px 0 10px; }
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: 600; }
        #post-feed-list, #my-post-feed-list { list-style: none; padding: 0; }
        #cooking-action-area { display: flex; gap: 10px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="app-header">
    <div class="header-content">
        <h1 class="app-title">ğŸ³ cookmate</h1>
        <div class="user-section">
            <input type="text" id="my-user-id" value="user1" placeholder="ID">
            <button onclick="loadData()" class="outline" style="width: auto; padding: 8px 12px; font-size: 0.8rem;">ğŸ”„</button>
        </div>
    </div>
</div>

<div class="container">
    <!-- ëƒ‰ì¥ê³  íƒ­ -->
    <div id="tab-home" class="tab-content active">
        <h2>ğŸ“¸ ì¬ë£Œ ì¶”ê°€</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <label for="my-img-input" class="file-label">ğŸ<br>ì‚¬ì§„ ì´¬ì˜</label>
            <label for="receipt-input" class="file-label" style="background:#f3f0ff; color:#7950f2; border-color:#b197fc;">ğŸ§¾<br>ì˜ìˆ˜ì¦ OCR</label>
        </div>
        <input type="file" id="my-img-input" accept="image/*" onchange="uploadImage()">
        <input type="file" id="receipt-input" accept="image/*" onchange="uploadReceipt()">
        <div id="vision-loading">ğŸ¤– ë¶„ì„ ì¤‘...</div>

        <div style="display: flex; gap: 8px; margin-top: 10px;">
            <input type="text" id="my-ing-name" placeholder="ì¬ë£Œ ì´ë¦„ (ì˜ˆ: ì–‘íŒŒ)" style="flex: 2;">
            <input type="text" id="my-ing-qty" placeholder="ìˆ˜ëŸ‰ (ì˜ˆ: 2ê°œ)" style="flex: 1;">
            <button onclick="addIngredient()" style="flex: 1;">â• ì¶”ê°€</button>
        </div>
        <h2>ğŸ§Š ë‚˜ì˜ ëƒ‰ì¥ê³ </h2>
        <ul id="ingredient-list"></ul>
        <div id="empty-msg" style="text-align: center; color: var(--text-light); margin-top: 20px;">ğŸ›’ ëƒ‰ì¥ê³ ê°€ ë¹„ì–´ìˆì–´ìš”! ì¬ë£Œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>
    </div>

    <!-- AI ì…°í”„ íƒ­ -->
    <div id="tab-recipe" class="tab-content">
        <div style="text-align: center; padding: 30px 0;">
            <button class="pref-btn" onclick="openPrefModal()">
                <strong>ğŸ§ ì–´ë–¤ ìš”ë¦¬ë¥¼ ë§Œë“¤ê¹Œìš”?</strong><br>
                <span style="font-size: 0.8rem; color: #868e96; font-weight: normal;">ì¬ë£Œë²”ìœ„, ì¢…ë¥˜, ìƒí™©, ë‚œì´ë„ ì„¤ì •</span>
            </button>

            <div style="font-size: 4rem;">ğŸ‘¨â€ğŸ³</div>
            <h3 style="color: var(--text);">AI ì…°í”„ì˜ ì¶”ì²œ</h3>
            <button onclick="generateRecipe()" style="width: auto; padding: 15px 30px; border-radius: 30px; margin-top: 15px;">âœ¨ ë ˆì‹œí”¼ ì¶”ì²œë°›ê¸°</button>
        </div>
        <div id="loading">ğŸ³ ìš”ë¦¬ ì¤€ë¹„ ì¤‘...</div>
        <div id="recipe-result">
            <h3 id="res-title" style="color: var(--primary); margin-bottom: 15px;"></h3>
            <p><strong>ğŸ›’ ì¬ë£Œ:</strong> <span id="res-materials"></span></p>
            <div id="res-steps" style="margin-top: 15px;"></div>
            <p id="res-tip" style="margin-top: 15px; padding: 12px; background: var(--hover); border-radius: 10px;"></p>
            <div id="cooking-action-area"></div>
        </div>
    </div>

    <!-- í”„ë¡œí•„ íƒ­ -->
    <div id="tab-profile" class="tab-content">
        <h2>ğŸ‘¤ ê¸°ë³¸ í”„ë¡œí•„</h2>
        <label>ğŸš« ì•Œë ˆë¥´ê¸°</label>
        <input type="text" id="prof-allergies" placeholder="ì˜ˆ: ë•…ì½©, ìƒˆìš°">
        <label style="margin-top: 15px;">ğŸ”ª ì¡°ë¦¬ë„êµ¬</label>
        <div class="scroll-container" id="tools-container"></div>
        <label style="margin-top: 15px;">ğŸ¯ ëª©í‘œ</label>
        <div class="scroll-container" id="goals-container"></div>
        <button onclick="saveProfile()" style="margin-top: 30px;">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
    </div>

    <!-- ì»¤ë®¤ë‹ˆí‹° íƒ­ -->
    <div id="tab-community" class="tab-content">
        <div class="comm-tabs" style="margin-top: 10px;">
            <div class="comm-tab active" data-tab="recommend" onclick="switchSubTab('recommend', this)">ğŸ”¥ ì¶”ì²œ</div>
            <div class="comm-tab" data-tab="mine" onclick="switchSubTab('mine', this)">ğŸ“ ë‚˜ì˜ ê¸€</div>
        </div>

        <div id="feed-recommend" class="sub-content active">
            <ul id="post-feed-list"></ul>
            <div id="empty-feed-recommend" style="text-align: center; color: var(--text-light); padding: 40px 0;">ì²« ë²ˆì§¸ í›„ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”! ğŸ“</div>
        </div>

        <div id="feed-mine" class="sub-content">
            <ul id="my-post-feed-list"></ul>
            <div id="empty-feed-mine" style="text-align: center; color: var(--text-light); padding: 40px 0;">ì•„ì§ ì‘ì„±í•œ ê¸€ì´ ì—†ì–´ìš”. âœï¸</div>
        </div>
    </div>
</div>

<!-- ë ˆì‹œí”¼ ì„¤ì • ëª¨ë‹¬ -->
<div id="pref-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ³ ë ˆì‹œí”¼ ì„¤ì •</h3>
            <button class="close-btn" onclick="closePrefModal()">âœ•</button>
        </div>
        <label>1. ì¬ë£Œ ë²”ìœ„</label>
        <div class="scroll-container" id="pref-scope-container"></div>
        <label style="margin-top: 20px;">2. ìš”ë¦¬ ì¢…ë¥˜</label>
        <div class="scroll-container" id="pref-type-container"></div>
        <label style="margin-top: 20px;">3. ìƒí™©</label>
        <div class="scroll-container" id="pref-occasion-container"></div>
        <label style="margin-top: 20px;">4. ë‚œì´ë„</label>
        <div class="scroll-container" id="pref-difficulty-container"></div>
        <button onclick="savePreferences()" style="margin-top: 30px;">âœ… ì„¤ì • ì €ì¥í•˜ê¸°</button>
    </div>
</div>

<!-- ì±—ë´‡ -->
<div class="chat-bubble">ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”? ğŸ’¬</div>
<div class="chat-fab" onclick="toggleChat()">ğŸ†˜</div>
<div id="chat-window">
    <div class="chat-header">
        <span>ğŸ‘¨â€ğŸ³ ì¿ í‚¹ ì–´ì‹œìŠ¤í„´íŠ¸</span>
        <button class="close-chat" onclick="toggleChat()">âœ•</button>
    </div>
    <div class="chat-messages" id="chat-messages">
        <div class="msg bot">ì•ˆë…•í•˜ì„¸ìš”! ğŸ³ ìš”ë¦¬ ì¤‘ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ë¬¼ì–´ë³´ì„¸ìš”!</div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
        <button onclick="sendChat()" style="width: 60px;">ì „ì†¡</button>
    </div>
</div>

<!-- ê¸€ì“°ê¸° ë²„íŠ¼ & ëª¨ë‹¬ -->
<div class="fab-write" onclick="openWriteModal()">âœï¸</div>
<div id="write-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“ í›„ê¸° ì‘ì„±</h3>
            <button class="close-btn" onclick="closeWriteModal()">âœ•</button>
        </div>
        <textarea id="post-content" class="write-textarea" placeholder="ìš”ë¦¬ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ë ˆì‹œí”¼ í›„ê¸°ë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”! ğŸ˜Š"></textarea>
        <label for="post-img-input" class="file-label" style="height: auto; padding: 15px; margin-bottom: 15px;">
            ğŸ“¸ ìš”ë¦¬ ì‚¬ì§„ ì˜¬ë¦¬ê¸°
        </label>
        <input type="file" id="post-img-input" accept="image/*">
        <button onclick="submitPost()">ğŸš€ ë“±ë¡í•˜ê¸°</button>
    </div>
</div>

<!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')"><span class="nav-icon">ğŸ§Š</span>ëƒ‰ì¥ê³ </button>
    <button class="nav-item" onclick="switchTab('recipe')"><span class="nav-icon">ğŸ§‘â€ğŸ³</span>AI ì…°í”„</button>
    <button class="nav-item" onclick="switchTab('community')"><span class="nav-icon">ğŸ’¬</span>ì»¤ë®¤ë‹ˆí‹°</button>
    <button class="nav-item" onclick="switchTab('profile')"><span class="nav-icon">ğŸ‘¤</span>í”„ë¡œí•„</button>
</nav>

<script>
// ========== ë°ì´í„° ì €ì¥ì†Œ (LocalStorage) ==========
const STORAGE_KEY = 'cookmate_data';
let appData = {
    users: {},
    ingredients: {},
    posts: [],
    nextIngredientId: 1,
    nextPostId: 1
};

function loadFromStorage() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) appData = { ...appData, ...JSON.parse(saved) };
}

function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
}

// ========== ë°ì´í„° ì •ì˜ ==========
const PREF_SCOPE = [{icon:"ğŸ ",name:"ì§‘ ì¬ë£Œë§Œ"}, {icon:"ğŸ›’",name:"ì™¸ë¶€ ì¬ë£Œ í¬í•¨"}];
const PREF_TYPE = [{icon:"ğŸš",name:"ì‹ì‚¬"}, {icon:"ğŸ¥ª",name:"ê°„ì‹"}, {icon:"ğŸº",name:"ì•ˆì£¼"}];
const PREF_OCCASION = [{icon:"ğŸ™",name:"í˜¼ì"}, {icon:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§",name:"ê°€ì¡±"}, {icon:"ğŸ‰",name:"ì†ë‹˜ì ‘ëŒ€"}];
const PREF_DIFFICULTY = [{icon:"ğŸ£",name:"ì‰¬ì›€"}, {icon:"ğŸ‘¨â€ğŸ³",name:"ë³´í†µ"}, {icon:"ğŸ”¥",name:"ì–´ë ¤ì›€"}];
const TOOL_LIST = [{icon:"ğŸ³",name:"í”„ë¼ì´íŒ¬"},{icon:"ğŸ”¥",name:"ê°€ìŠ¤ë ˆì¸ì§€"},{icon:"ğŸ¥˜",name:"ëƒ„ë¹„"},{icon:"â™¨ï¸",name:"ì—ì–´í”„ë¼ì´ì–´"},{icon:"ğŸ•",name:"ì˜¤ë¸"},{icon:"âš¡",name:"ì „ìë ˆì¸ì§€"}];
const GOAL_LIST = [{icon:"ğŸ¥—",name:"ë‹¤ì´ì–´íŠ¸"},{icon:"ğŸ’ª",name:"ê³ ë‹¨ë°±"},{icon:"ğŸ§‚",name:"ì €ì—¼ì‹"},{icon:"ğŸŒ¿",name:"ë¹„ê±´"}];

// ========== UI í—¬í¼ í•¨ìˆ˜ ==========
function createBlocks(containerId, list, selectedStr, multiSelect = true) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    const selected = selectedStr ? selectedStr.split(',').map(s => s.trim()) : [];
    
    list.forEach(item => {
        const block = document.createElement('div');
        block.className = 'select-block';
        if (selected.includes(item.name)) block.classList.add('selected');
        
        block.onclick = () => {
            if (!multiSelect) {
                Array.from(container.children).forEach(c => c.classList.remove('selected'));
            }
            block.classList.toggle('selected');
        };
        
        block.innerHTML = `<span class="block-icon">${item.icon}</span><span class="block-text">${item.name}</span>`;
        container.appendChild(block);
    });
}

function getSelectedValues(containerId) {
    return Array.from(document.querySelectorAll(`#${containerId} .select-block.selected .block-text`))
        .map(el => el.textContent).join(',');
}

// ========== ëª¨ë‹¬ ì œì–´ ==========
function openPrefModal() { document.getElementById('pref-modal').style.display = 'flex'; }
function closePrefModal() { document.getElementById('pref-modal').style.display = 'none'; }
function openWriteModal() {
    if (!document.getElementById('my-user-id').value) {
        alert('ì‚¬ìš©ì IDë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
    }
    document.getElementById('write-modal').style.display = 'flex';
}
function closeWriteModal() {
    document.getElementById('write-modal').style.display = 'none';
    document.getElementById('post-content').value = '';
    document.getElementById('post-img-input').value = '';
}
function toggleChat() {
    const chatWindow = document.getElementById('chat-window');
    chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
}

// ========== íƒ­ ì „í™˜ ==========
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach((item, i) => {
        const tabs = ['home', 'recipe', 'community', 'profile'];
        item.classList.toggle('active', tabs[i] === tabName);
    });

    // í”Œë¡œíŒ… ë²„íŠ¼ ì œì–´
    document.querySelector('.chat-fab').style.display = tabName === 'recipe' ? 'flex' : 'none';
    document.querySelector('.chat-bubble').style.display = tabName === 'recipe' ? 'block' : 'none';
    document.querySelector('.fab-write').style.display = tabName === 'community' ? 'flex' : 'none';

    if (tabName === 'community') {
        switchSubTab('recommend', document.querySelector('.comm-tab[data-tab="recommend"]'));
    }
}

// ========== ë°ì´í„° ë¡œë“œ ==========
function loadData() {
    loadFromStorage();
    const uid = document.getElementById('my-user-id').value;

    // ì¬ë£Œ ë¡œë“œ
    const ingredients = appData.ingredients[uid] || [];
    const list = document.getElementById('ingredient-list');
    list.innerHTML = '';
    
    if (ingredients.length === 0) {
        document.getElementById('empty-msg').style.display = 'block';
    } else {
        document.getElementById('empty-msg').style.display = 'none';
        ingredients.forEach(ing => {
            list.innerHTML += `
                <li class="ingredient-item">
                    <span>${ing.name} ${ing.quantity}</span>
                    <button class="delete-btn" onclick="deleteIngredient('${ing.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                </li>`;
        });
    }

    // ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
    const userData = appData.users[uid] || {};
    document.getElementById('prof-allergies').value = userData.allergies || '';
    createBlocks('tools-container', TOOL_LIST, userData.tools || '', true);
    createBlocks('goals-container', GOAL_LIST, userData.goals || '', true);
    createBlocks('pref-scope-container', PREF_SCOPE, userData.pref_scope || '', false);
    createBlocks('pref-type-container', PREF_TYPE, userData.pref_type || '', false);
    createBlocks('pref-occasion-container', PREF_OCCASION, userData.pref_occasion || '', false);
    createBlocks('pref-difficulty-container', PREF_DIFFICULTY, userData.pref_difficulty || '', false);
}

// ========== ì¬ë£Œ CRUD ==========
function addIngredient() {
    const uid = document.getElementById('my-user-id').value;
    const name = document.getElementById('my-ing-name').value.trim();
    const qty = document.getElementById('my-ing-qty').value.trim();
    
    if (!name) { alert('ì¬ë£Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

    if (!appData.ingredients[uid]) appData.ingredients[uid] = [];
    
    appData.ingredients[uid].push({
        id: 'ing_' + appData.nextIngredientId++,
        name: name,
        quantity: qty || 'ì ë‹¹ëŸ‰',
        timestamp: new Date().toISOString()
    });
    
    saveToStorage();
    document.getElementById('my-ing-name').value = '';
    document.getElementById('my-ing-qty').value = '';
    loadData();
    alert('âœ… ì¬ë£Œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function deleteIngredient(id) {
    const uid = document.getElementById('my-user-id').value;
    if (!appData.ingredients[uid]) return;
    
    appData.ingredients[uid] = appData.ingredients[uid].filter(ing => ing.id !== id);
    saveToStorage();
    loadData();
}

// ========== í”„ë¡œí•„ ì €ì¥ ==========
function saveProfile() {
    const uid = document.getElementById('my-user-id').value;
    if (!appData.users[uid]) appData.users[uid] = {};
    
    appData.users[uid] = {
        ...appData.users[uid],
        allergies: document.getElementById('prof-allergies').value,
        tools: getSelectedValues('tools-container'),
        goals: getSelectedValues('goals-container')
    };
    
    saveToStorage();
    alert('ğŸ’¾ í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function savePreferences() {
    const uid = document.getElementById('my-user-id').value;
    if (!appData.users[uid]) appData.users[uid] = {};
    
    appData.users[uid] = {
        ...appData.users[uid],
        pref_scope: getSelectedValues('pref-scope-container'),
        pref_type: getSelectedValues('pref-type-container'),
        pref_occasion: getSelectedValues('pref-occasion-container'),
        pref_difficulty: getSelectedValues('pref-difficulty-container')
    };
    
    saveToStorage();
    closePrefModal();
    alert('âœ… ë ˆì‹œí”¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// ========== AI ë ˆì‹œí”¼ ìƒì„± ==========
function generateRecipe() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('recipe-result').style.display = 'none';

    setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        
        const recipes = [
            {
                name: "ğŸ ë§¤ì½¤ í† ë§ˆí†  íŒŒìŠ¤íƒ€",
                materials: ["ìŠ¤íŒŒê²Œí‹°ë©´ 200g", "í† ë§ˆí†  3ê°œ", "ë§ˆëŠ˜ 3ìª½", "ì–‘íŒŒ 1ê°œ", "ì˜¬ë¦¬ë¸Œìœ "],
                steps: ["ë¬¼ì„ ë“ì—¬ ìŠ¤íŒŒê²Œí‹°ë©´ì„ 8ë¶„ ì‚¶ìŠµë‹ˆë‹¤", "í† ë§ˆí† ì™€ ì–‘íŒŒ, ë§ˆëŠ˜ì„ ë‹¤ì ¸ ì˜¬ë¦¬ë¸Œìœ ì— ë³¶ìŠµë‹ˆë‹¤", "ì‚¶ì€ ë©´ì„ ì†ŒìŠ¤ì— ë²„ë¬´ë ¤ ì™„ì„±í•©ë‹ˆë‹¤"],
                tip: "ğŸŒ¿ ë°”ì§ˆì„ ì˜¬ë¦¬ë©´ í–¥ì´ ë” ì¢‹ì•„ìš”!"
            },
            {
                name: "ğŸ¥— ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ",
                materials: ["ë‹­ê°€ìŠ´ì‚´ 200g", "ì–‘ìƒì¶”", "í† ë§ˆí†  2ê°œ", "ë“œë ˆì‹±"],
                steps: ["ë‹­ê°€ìŠ´ì‚´ì„ ì†Œê¸ˆ, í›„ì¶”ë¡œ ê°„í•´ êµ½ìŠµë‹ˆë‹¤", "ì±„ì†Œë¥¼ ì”»ì–´ ê·¸ë¦‡ì— ë‹´ìŠµë‹ˆë‹¤", "êµ¬ìš´ ë‹­ê°€ìŠ´ì‚´ì„ ì˜¬ë¦¬ê³  ë“œë ˆì‹±ì„ ë¿Œë¦½ë‹ˆë‹¤"],
                tip: "ğŸ’¡ ë ˆëª¬ì¦™ì„ ë¿Œë¦¬ë©´ ìƒí¼í•´ìš”!"
            },
            {
                name: "ğŸ³ ê°„ë‹¨ ê³„ë€ë³¶ìŒë°¥",
                materials: ["ë°¥ 1ê³µê¸°", "ê³„ë€ 2ê°œ", "íŒŒ ì•½ê°„", "ê°„ì¥"],
                steps: ["íŒ¬ì— ê¸°ë¦„ì„ ë‘ë¥´ê³  ê³„ë€ì„ ìŠ¤í¬ë¨ë¸”í•©ë‹ˆë‹¤", "ë°¥ì„ ë„£ê³  ì˜ ì„ì–´ì¤ë‹ˆë‹¤", "ê°„ì¥ìœ¼ë¡œ ê°„ì„ í•˜ê³  íŒŒë¥¼ ë¿Œë¦½ë‹ˆë‹¤"],
                tip: "ğŸ”¥ ì„¼ ë¶ˆì—ì„œ ë¹ ë¥´ê²Œ ë³¶ìœ¼ì„¸ìš”!"
            }
        ];
        
        const recipe = recipes[Math.floor(Math.random() * recipes.length)];
        
        window.currentRecipeName = recipe.name;
        window.currentRecipeMaterials = recipe.materials.join(', ');
        
        document.getElementById('res-title').textContent = recipe.name;
        document.getElementById('res-materials').textContent = recipe.materials.join(' â€¢ ');
        document.getElementById('res-steps').innerHTML = recipe.steps.map((s, i) => 
            `<p style="margin: 8px 0; padding: 10px; background: var(--bg); border-radius: 8px;">${i+1}. ${s}</p>`
        ).join('');
        document.getElementById('res-tip').innerHTML = `<strong>ğŸ’¡ íŒ:</strong> ${recipe.tip}`;
        
        document.getElementById('cooking-action-area').innerHTML = `
            <button id="start-cooking-btn" onclick="startCooking()" style="background: #20c997; flex: 1;">ğŸš€ ìš”ë¦¬ ì‹œì‘</button>
            <button id="finish-cooking-btn" class="hidden" onclick="finishCooking()" style="background: #fa5252; flex: 1;">âœ… ìš”ë¦¬ ì™„ë£Œ</button>
        `;
        
        document.getElementById('recipe-result').style.display = 'block';
    }, 1500);
}

function startCooking() {
    document.getElementById('start-cooking-btn').classList.add('hidden');
    document.getElementById('finish-cooking-btn').classList.remove('hidden');
    alert(`ğŸ³ [${window.currentRecipeName}] ìš”ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!`);
}

function finishCooking() {
    if (!confirm(`âœ… [${window.currentRecipeName}] ìš”ë¦¬ ì™„ë£Œ!\nì¬ë£Œë¥¼ ëƒ‰ì¥ê³ ì—ì„œ ì°¨ê°í• ê¹Œìš”?`)) {
        document.getElementById('start-cooking-btn').classList.remove('hidden');
        document.getElementById('finish-cooking-btn').classList.add('hidden');
        return;
    }
    
    const uid = document.getElementById('my-user-id').value;
    if (appData.ingredients[uid] && appData.ingredients[uid].length > 0) {
        appData.ingredients[uid] = appData.ingredients[uid].slice(Math.min(2, appData.ingredients[uid].length));
        saveToStorage();
        loadData();
    }
    
    alert('ğŸ‰ ìš”ë¦¬ ì™„ë£Œ! ì¬ë£Œê°€ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤.');
    document.getElementById('start-cooking-btn').classList.remove('hidden');
    document.getElementById('finish-cooking-btn').classList.add('hidden');
}

// ========== ì»¤ë®¤ë‹ˆí‹° ==========
let currentCommunityFilter = 'recommend';

function switchSubTab(tabName, element) {
    document.querySelectorAll('.comm-tab').forEach(t => t.classList.remove('active'));
    element.classList.add('active');
    
    document.querySelectorAll('.sub-content').forEach(c => c.classList.remove('active'));
    document.getElementById('feed-' + tabName).classList.add('active');
    
    currentCommunityFilter = tabName;
    loadCommunityPosts(tabName === 'mine');
}

function loadCommunityPosts(isMine) {
    const uid = document.getElementById('my-user-id').value;
    let posts = appData.posts || [];
    
    if (isMine) {
        posts = posts.filter(p => p.userId === uid);
    }
    
    renderPosts(posts, isMine);
}

function renderPosts(posts, isMine) {
    const listId = isMine ? 'my-post-feed-list' : 'post-feed-list';
    const emptyId = isMine ? 'empty-feed-mine' : 'empty-feed-recommend';
    const list = document.getElementById(listId);
    
    list.innerHTML = '';
    
    if (posts.length === 0) {
        document.getElementById(emptyId).style.display = 'block';
        return;
    }
    
    document.getElementById(emptyId).style.display = 'none';
    
    posts.forEach(post => {
        list.innerHTML += `
            <li class="feed-card">
                <div class="feed-header">
                    <div class="profile-pic">ğŸ‘¤</div>
                    <div>
                        <strong>${post.userId}</strong>
                        <div style="font-size: 11px; color: #888;">${new Date(post.timestamp).toLocaleDateString('ko-KR')}</div>
                    </div>
                </div>
                <div class="feed-img">ğŸ“¸ ìš”ë¦¬ ì‚¬ì§„</div>
                <div class="feed-body">
                    <p class="feed-text">${post.content}</p>
                    <div class="feed-meta">
                        <span>â¤ï¸ ${post.likes || 0}ê°œ</span>
                        <button class="like-btn" onclick="toggleLike('${post.id}')">ğŸ‘ ì¢‹ì•„ìš”</button>
                    </div>
                </div>
            </li>`;
    });
}

function submitPost() {
    const uid = document.getElementById('my-user-id').value;
    const content = document.getElementById('post-content').value.trim();
    
    if (!content) {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
    }
    
    appData.posts.unshift({
        id: 'post_' + appData.nextPostId++,
        userId: uid,
        content: content,
        likes: 0,
        timestamp: new Date().toISOString()
    });
    
    saveToStorage();
    closeWriteModal();
    loadCommunityPosts(currentCommunityFilter === 'mine');
    alert('ğŸ‰ í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

function toggleLike(postId) {
    const post = appData.posts.find(p => p.id === postId);
    if (post) {
        post.likes = (post.likes || 0) + 1;
        saveToStorage();
        loadCommunityPosts(currentCommunityFilter === 'mine');
    }
}

// ========== ì±—ë´‡ ==========
function sendChat() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;
    
    const messages = document.getElementById('chat-messages');
    messages.innerHTML += `<div class="msg user">${message}</div>`;
    input.value = '';
    
    setTimeout(() => {
        const responses = [
            "ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”! ğŸ˜Š",
            "íŒ¬ì€ ì¤‘ë¶ˆë¡œ ì˜ˆì—´í•˜ì„¸ìš”! ğŸ”¥",
            "ì†Œê¸ˆì€ ë§ˆì§€ë§‰ì— ë„£ìœ¼ì„¸ìš”! ğŸ§‚",
            "íƒ€ì´ë¨¸ ì„¤ì • ìŠì§€ ë§ˆì„¸ìš”! â±ï¸",
            "ë§›ìˆê²Œ ë§Œë“œì„¸ìš”! ğŸ‘¨â€ğŸ³"
        ];
        messages.innerHTML += `<div class="msg bot">${responses[Math.floor(Math.random() * responses.length)]}</div>`;
        messages.scrollTop = messages.scrollHeight;
    }, 500);
}

// ========== ì´ë¯¸ì§€ ì—…ë¡œë“œ í”Œë ˆì´ìŠ¤í™€ë” ==========
function uploadImage() {
    alert('ğŸ“¸ ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œ! (ë°±ì—”ë“œ ì—°ë™ ì‹œ Gemini Visionìœ¼ë¡œ ì¬ë£Œ ì¸ì‹)');
}

function uploadReceipt() {
    alert('ğŸ§¾ ì˜ìˆ˜ì¦ ë¶„ì„ ì™„ë£Œ! (ë°±ì—”ë“œ ì—°ë™ ì‹œ OCRë¡œ ì¬ë£Œ ìë™ ì¶”ê°€)');
}

// ========== ì´ˆê¸°í™” ==========
window.onload = function() {
    loadFromStorage();
    loadData();
    switchTab('home');
    
    document.getElementById('chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendChat();
    });
};
</script>
</body>
</html>
