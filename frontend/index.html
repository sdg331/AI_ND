<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FridgeChef - ë‚´ ëƒ‰ì¥ê³  AI ì…°í”„</title>
    <style>
        /* ìŠ¤íƒ€ì¼(ë””ìì¸) ì •ì˜ */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f9f9f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #ff6b6b; margin-bottom: 30px; }
        h2 { font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; color: #444; }
        
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; border-radius: 8px; border: 1px solid #ddd; }
        button { background-color: #ff6b6b; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background-color: #fa5252; }
        button.secondary { background-color: #868e96; }
        button.vision-btn { background-color: #4c6ef5; } /* ì‚¬ì§„ ë²„íŠ¼ì€ íŒŒë€ìƒ‰ */

        #ingredient-list { list-style: none; padding: 0; }
        .ingredient-item { background: #f1f3f5; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { background: #ff8787; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; width: auto; margin: 0; }

        #loading { display: none; text-align: center; margin: 20px 0; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #recipe-result { display: none; background: #fff0f6; padding: 20px; border-radius: 10px; border: 2px solid #ffdeeb; margin-top: 20px; }
        .step { margin-bottom: 10px; padding-left: 20px; position: relative; }
        .step:before { content: "ğŸ³"; position: absolute; left: 0; }
        
        /* íŒŒì¼ ì—…ë¡œë“œ ìˆ¨ê¹€ ìŠ¤íƒ€ì¼ */
        input[type="file"] { display: none; }
        .file-label { display: block; padding: 10px; background: #e7f5ff; color: #228be6; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px dashed #228be6; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘©â€ğŸ³ FridgeChef</h1>

    <div style="text-align: right; font-size: 0.8rem; color: #888;">
        ì‚¬ìš©ì ID: <input type="text" id="user-id" value="user1" style="width: 60px; padding: 5px; display: inline-block;">
        <button onclick="loadData()" style="width: auto; padding: 5px 10px; font-size: 0.8rem;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <h2>ğŸ‘¤ ë‚´ ì…ë§› í”„ë¡œí•„</h2>
    <input type="text" id="allergies" placeholder="ì•Œë ˆë¥´ê¸° (ì˜ˆ: ë•…ì½©, ìƒˆìš°)">
    <input type="text" id="tools" placeholder="ì¡°ë¦¬ë„êµ¬ (ì˜ˆ: ì—ì–´í”„ë¼ì´ì–´, ëƒ„ë¹„)">
    <button class="secondary" onclick="saveProfile()">í”„ë¡œí•„ ì €ì¥</button>

    <h2>ğŸ§Š ëƒ‰ì¥ê³  ì† ì¬ë£Œ</h2>
    
    <div style="margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 8px;">
        <label for="img-input" class="file-label">ğŸ“¸ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì¬ë£Œ ì‚¬ì§„ ì°ê¸°/ì—…ë¡œë“œ</label>
        <input type="file" id="img-input" accept="image/*" onchange="uploadImage()">
        <div id="vision-loading" style="display:none; color: #4c6ef5; text-align: center; font-size: 0.9rem;">ğŸ¤– ì‚¬ì§„ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>

    <div style="display: flex; gap: 5px;">
        <input type="text" id="ing-name" placeholder="ì§ì ‘ ì…ë ¥ (ì˜ˆ: ì‚¼ê²¹ì‚´)">
        <input type="text" id="ing-qty" placeholder="ìˆ˜ëŸ‰ (ì˜ˆ: 300g)" style="width: 30%;">
    </div>
    <button onclick="addIngredient()">ì¬ë£Œ ë„£ê¸°</button>
    
    <ul id="ingredient-list"></ul>

    <h2>âœ¨ AI ì…°í”„ì˜ ì¶”ì²œ</h2>
    <button onclick="generateRecipe()" style="height: 50px; font-size: 1.1rem;">ğŸ§‘â€ğŸ³ ì§€ê¸ˆ ë°”ë¡œ ìš”ë¦¬ ì¶”ì²œë°›ê¸°!</button>

    <div id="loading">
        <div class="spinner"></div>
        <p>AI ì…°í”„ê°€ ëƒ‰ì¥ê³ ë¥¼ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</p>
    </div>

    <div id="recipe-result">
        <h3 id="res-title"></h3>
        <p><strong>ì‚¬ìš© ì¬ë£Œ:</strong> <span id="res-materials"></span></p>
        <h4>ì¡°ë¦¬ ìˆœì„œ</h4>
        <div id="res-steps"></div>
        <p style="margin-top: 15px; color: #e64980;"><strong>ğŸ’¡ ì…°í”„ì˜ íŒ:</strong> <span id="res-tip"></span></p>
    </div>
</div>

<script>
    const API_URL = "http://127.0.0.1:5000";

    async function loadData() {
        const userId = document.getElementById('user-id').value;
        try {
            const resUser = await fetch(`${API_URL}/users/${userId}`);
            const userData = await resUser.json();
            if (!userData.error) {
                document.getElementById('allergies').value = userData.allergies || '';
                document.getElementById('tools').value = userData.tools || '';
            }
        } catch (e) {}

        try {
            const resIng = await fetch(`${API_URL}/ingredients/${userId}`);
            const ingredients = await resIng.json();
            renderIngredients(ingredients);
        } catch (e) {}
    }

    function renderIngredients(list) {
        const ul = document.getElementById('ingredient-list');
        ul.innerHTML = '';
        list.forEach(item => {
            const li = document.createElement('li');
            li.className = 'ingredient-item';
            // ë¹„ì „ìœ¼ë¡œ ë“±ë¡ëœê±´ ì•„ì´ì½˜ í‘œì‹œ
            const icon = item.registrationType === 'vision' ? 'ğŸ“¸' : 'ğŸ“';
            li.innerHTML = `
                <span>${icon} ${item.name} (${item.quantity})</span>
                <button class="delete-btn" onclick="deleteIngredient('${item.id}')">ì‚­ì œ</button>
            `;
            ul.appendChild(li);
        });
    }

    // [ì¶”ê°€ë¨] ì‚¬ì§„ ì—…ë¡œë“œ í•¨ìˆ˜
    async function uploadImage() {
        const fileInput = document.getElementById('img-input');
        const file = fileInput.files[0];
        if (!file) return;

        const userId = document.getElementById('user-id').value;
        
        // ë¡œë”© í‘œì‹œ
        document.getElementById('vision-loading').style.display = 'block';
        document.querySelector('.file-label').innerText = "ë¶„ì„ ì¤‘...";

        const formData = new FormData();
        formData.append('image', file);
        formData.append('userId', userId);

        try {
            const response = await fetch(`${API_URL}/ingredients/vision`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.error) {
                alert("ì‹¤íŒ¨: " + result.error);
            } else {
                alert(`ì„±ê³µ! AIê°€ '${result.name}'ì„(ë¥¼) ë°œê²¬í–ˆìŠµë‹ˆë‹¤.`);
                loadData(); // ëª©ë¡ ê°±ì‹ 
            }
        } catch (e) {
            alert("ì—…ë¡œë“œ ì˜¤ë¥˜ ë°œìƒ");
            console.error(e);
        } finally {
            document.getElementById('vision-loading').style.display = 'none';
            document.querySelector('.file-label').innerText = "ğŸ“¸ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì¬ë£Œ ì‚¬ì§„ ì°ê¸°/ì—…ë¡œë“œ";
            fileInput.value = ''; // ì…ë ¥ ì´ˆê¸°í™”
        }
    }

    async function saveProfile() {
        const userId = document.getElementById('user-id').value;
        const data = {
            username: "User",
            allergies: document.getElementById('allergies').value,
            tools: document.getElementById('tools').value
        };
        await fetch(`${API_URL}/users/${userId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        alert("í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    async function addIngredient() {
        const userId = document.getElementById('user-id').value;
        const name = document.getElementById('ing-name').value;
        const qty = document.getElementById('ing-qty').value;

        if (!name) return alert("ì¬ë£Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

        await fetch(`${API_URL}/ingredients/${userId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, quantity: qty })
        });

        document.getElementById('ing-name').value = '';
        document.getElementById('ing-qty').value = '';
        loadData();
    }

    async function deleteIngredient(id) {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`${API_URL}/ingredients/delete/${id}`, { method: 'POST' });
        loadData();
    }

    async function generateRecipe() {
        const userId = document.getElementById('user-id').value;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('recipe-result').style.display = 'none';

        try {
            const response = await fetch(`${API_URL}/ai/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId })
            });
            const result = await response.json();
            
            if (result.error) {
                alert(result.error);
            } else {
                document.getElementById('res-title').innerText = result.recipeName;
                document.getElementById('res-materials').innerText = result.materialsUsed;
                document.getElementById('res-tip').innerText = result.tip;
                const stepsDiv = document.getElementById('res-steps');
                stepsDiv.innerHTML = '';
                result.cookingSteps.forEach(step => {
                    const p = document.createElement('p');
                    p.className = 'step';
                    p.innerText = step;
                    stepsDiv.appendChild(p);
                });
                document.getElementById('recipe-result').style.display = 'block';
            }
        } catch (e) {
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    window.onload = loadData;
</script>

</body>
</html>
